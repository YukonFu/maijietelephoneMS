<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»´ä¿®çœ‹æ¿ - è¿ˆæ·æ‰‹æœºå†…éƒ¨æµç¨‹ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">
            <span class="logo">ğŸ“±</span>
            <h1>æ‰‹æœºç»´ä¿®ç®¡ç†</h1>
        </a>
        <ul class="navbar-menu">
            <li><a href="index.html">ğŸ  é¦–é¡µ</a></li>
            <li><a href="register.html">ğŸ“ ç™»è®°</a></li>
            <li><a href="front-desk.html">ğŸ“º å‰å°çœ‹æ¿</a></li>
            <li><a href="repair.html" class="active">ğŸ”§ ç»´ä¿®çœ‹æ¿</a></li>
            <li><a href="customers.html">ğŸ‘¥ å®¢æˆ·</a></li>
            <li><a href="pricing.html">ğŸ’° ä»·æ ¼ç®¡ç†</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-header">
            <h2>ğŸ”§ ç»´ä¿®çœ‹æ¿</h2>
            <p>æ‹–æ‹½å·¥å•å¡ç‰‡æ›´æ–°çŠ¶æ€ï¼Œç‚¹å‡»ç¼–è¾‘è¯¦æƒ…</p>
        </div>

        <!-- çœ‹æ¿ -->
        <div class="kanban-container">
            <div class="kanban-column" data-status="ç­‰å¾…è®¢è´§">
                <div class="kanban-column-header">
                    <span>ğŸ“¦</span>
                    <span class="kanban-column-title">ç­‰å¾…è®¢è´§</span>
                    <span class="kanban-column-count" id="count-ç­‰å¾…è®¢è´§">0</span>
                </div>
                <div class="kanban-cards" id="cards-ç­‰å¾…è®¢è´§"></div>
            </div>

            <div class="kanban-column" data-status="å¾…ç»´ä¿®">
                <div class="kanban-column-header">
                    <span>â³</span>
                    <span class="kanban-column-title">å¾…ç»´ä¿®</span>
                    <span class="kanban-column-count" id="count-å¾…ç»´ä¿®">0</span>
                </div>
                <div class="kanban-cards" id="cards-å¾…ç»´ä¿®"></div>
            </div>

            <div class="kanban-column" data-status="ç»´ä¿®ä¸­">
                <div class="kanban-column-header">
                    <span>ğŸ”§</span>
                    <span class="kanban-column-title">ç»´ä¿®ä¸­</span>
                    <span class="kanban-column-count" id="count-ç»´ä¿®ä¸­">0</span>
                </div>
                <div class="kanban-cards" id="cards-ç»´ä¿®ä¸­"></div>
            </div>

            <div class="kanban-column" data-status="å¾…å–æœº">
                <div class="kanban-column-header">
                    <span>ğŸ“¦</span>
                    <span class="kanban-column-title">å¾…å–æœº</span>
                    <span class="kanban-column-count" id="count-å¾…å–æœº">0</span>
                </div>
                <div class="kanban-cards" id="cards-å¾…å–æœº"></div>
            </div>

            <div class="kanban-column" data-status="å·²å®Œæˆ">
                <div class="kanban-column-header">
                    <span>âœ…</span>
                    <span class="kanban-column-title">å·²å®Œæˆ</span>
                    <span class="kanban-column-count" id="count-å·²å®Œæˆ">0</span>
                </div>
                <div class="kanban-cards" id="cards-å·²å®Œæˆ"></div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘å·¥å•æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h3>ç¼–è¾‘å·¥å•</h3>
                <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editOrderId">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--accent-purple);"
                            id="editOrderNo"></div>
                        <div style="color: var(--text-muted); font-size: 0.9rem;" id="editOrderInfo"></div>
                    </div>
                </div>

                <!-- è®¾å¤‡å¯†ç ä¿¡æ¯ -->
                <div id="passwordInfoSection"
                    style="display: none; margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-glass); border-radius: var(--radius-md); border: 1px solid var(--border-glass);">
                    <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--text-secondary);">ğŸ” è®¾å¤‡è§£é”ä¿¡æ¯</div>
                    <div id="passwordInfoContent" style="font-size: 0.9rem;"></div>
                </div>

                <!-- æ•…éšœæè¿° -->
                <div id="problemSection"
                    style="margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, rgba(255,107,107,0.1), rgba(255,142,83,0.1)); border-radius: var(--radius-md); border: 1px solid rgba(255,107,107,0.3);">
                    <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-orange);">âš ï¸ æ•…éšœæè¿°</div>
                    <div id="problemContent"
                        style="font-size: 0.95rem; white-space: pre-line; color: var(--text-primary);"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">å½“å‰çŠ¶æ€</label>
                    <select class="form-control" id="editStatus">
                        <option value="ç­‰å¾…è®¢è´§">ç­‰å¾…è®¢è´§</option>
                        <option value="å¾…ç»´ä¿®">å¾…ç»´ä¿®</option>
                        <option value="ç»´ä¿®ä¸­">ç»´ä¿®ä¸­</option>
                        <option value="å¾…å–æœº">å¾…å–æœº</option>
                        <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                    </select>
                </div>

                <div class="form-group" id="editOrderChannelGroup">
                    <label class="form-label">ğŸ›’ è®¢è´§æ¸ é“</label>
                    <select class="form-control" id="editOrderChannel">
                        <option value="">æ— </option>
                        <option value="it-ricambi">it-ricambi</option>
                        <option value="37smart">37smart</option>
                        <option value="Amazon">Amazon</option>
                        <option value="å…¶å®ƒ">å…¶å®ƒ</option>
                    </select>
                    <input type="text" class="form-control" id="editCustomChannel"
                        style="display: none; margin-top: 0.5rem;" placeholder="è¯·è¾“å…¥å…¶å®ƒæ¸ é“åç§°...">
                </div>

                <div class="form-group">
                    <label class="form-label">ç»´ä¿®å¤‡æ³¨</label>
                    <textarea class="form-control" id="editNotes" placeholder="è®°å½•ç»´ä¿®è¿‡ç¨‹ã€æ›´æ¢é…ä»¶ç­‰ä¿¡æ¯..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">å®é™…ä»·æ ¼ (â‚¬)</label>
                        <input type="number" class="form-control" id="editFinalPrice" step="0.01" min="0">
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-ghost" onclick="closeModal('editModal')">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-warning" onclick="printCurrentOrder()">ğŸ–¨ï¸ æ‰“å°</button>
                    <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script>
        let allOrders = [];
        let currentOrder = null;
        let draggedCard = null;

        // åŠ è½½å·¥å•
        async function loadOrders() {
            try {
                allOrders = await API.orders.getAll();
                renderKanban();
            } catch (error) {
                console.error('åŠ è½½å·¥å•å¤±è´¥:', error);
                utils.showToast('åŠ è½½å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“çœ‹æ¿
        function renderKanban() {
            const statuses = ['ç­‰å¾…è®¢è´§', 'å¾…ç»´ä¿®', 'ç»´ä¿®ä¸­', 'å¾…å–æœº', 'å·²å®Œæˆ'];
            const threeDaysAgo = new Date();
            threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);

            statuses.forEach(status => {
                const container = document.getElementById(`cards-${status}`);
                const countEl = document.getElementById(`count-${status}`);

                // å·²å®Œæˆçš„å·¥å•åªæ˜¾ç¤º3å¤©å†…çš„
                let orders = allOrders.filter(o => o.status === status);
                if (status === 'å·²å®Œæˆ') {
                    orders = orders.filter(o => new Date(o.created_at) >= threeDaysAgo);
                }

                countEl.textContent = orders.length;

                if (orders.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>æš‚æ— å·¥å•</p></div>';
                } else {
                    container.innerHTML = orders.map(order => `
                        <div class="order-card fade-in" draggable="true" data-id="${order.id}" data-status="${order.status}">
                            <div class="order-card-header">
                                <span class="order-no">${order.order_no}</span>
                                <span class="order-time">${utils.formatDate(order.created_at)}</span>
                            </div>
                            <div class="order-device">${order.device_brand} ${order.device_model}</div>
                            <div class="order-problem">${order.problem}</div>
                            ${order.order_channel ? `<div style="margin-top: 0.5rem;"><span style="background: linear-gradient(135deg, rgba(245, 87, 108, 0.2), rgba(240, 147, 251, 0.2)); color: var(--accent-orange); padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.75rem;">ğŸ›’ ${order.order_channel}</span></div>` : ''}
                            <div class="order-customer">
                                <span>ğŸ‘¤ ${order.customer_name || '-'}</span>
                                <span class="order-price">${utils.formatPrice(order.final_price || order.estimated_price)}</span>
                            </div>
                        </div>
                    `).join('');
                }

                setupDragAndDrop(container);
            });

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.order-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.dragging')) {
                        showEditModal(parseInt(card.dataset.id));
                    }
                });
            });
        }

        // è®¾ç½®æ‹–æ‹½
        function setupDragAndDrop(container) {
            const cards = container.querySelectorAll('.order-card');

            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    draggedCard = card;
                    card.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                    draggedCard = null;
                    document.querySelectorAll('.kanban-cards').forEach(c => c.classList.remove('drag-over'));
                });
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                container.classList.add('drag-over');
            });

            container.addEventListener('dragleave', () => {
                container.classList.remove('drag-over');
            });

            container.addEventListener('drop', async (e) => {
                e.preventDefault();
                container.classList.remove('drag-over');

                if (!draggedCard) return;

                const newStatus = container.closest('.kanban-column').dataset.status;
                const orderId = parseInt(draggedCard.dataset.id);
                const oldStatus = draggedCard.dataset.status;

                if (newStatus !== oldStatus) {
                    try {
                        await API.orders.updateStatus(orderId, newStatus);
                        utils.showToast(`çŠ¶æ€å·²æ›´æ–°ä¸º"${newStatus}"`);
                        loadOrders();
                    } catch (error) {
                        utils.showToast('æ›´æ–°å¤±è´¥', 'error');
                    }
                }
            });
        }

        // æ ¼å¼åŒ–å›¾æ¡ˆå¯†ç æ˜¾ç¤º
        function formatPatternPassword(pattern) {
            if (!pattern) return '';
            return pattern.split(',').map(i => parseInt(i) + 1).join(' â†’ ');
        }

        // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
        async function showEditModal(id) {
            try {
                currentOrder = await API.orders.getById(id);

                document.getElementById('editOrderId').value = currentOrder.id;
                document.getElementById('editOrderNo').textContent = currentOrder.order_no;
                document.getElementById('editOrderInfo').textContent =
                    `${currentOrder.device_brand} ${currentOrder.device_model} | ${currentOrder.customer_name || '-'}`;
                document.getElementById('editStatus').value = currentOrder.status;
                document.getElementById('editNotes').value = currentOrder.repair_notes || '';
                document.getElementById('editFinalPrice').value = currentOrder.final_price || currentOrder.estimated_price || '';

                // æ˜¾ç¤ºå¯†ç ä¿¡æ¯
                const passwordSection = document.getElementById('passwordInfoSection');
                const passwordContent = document.getElementById('passwordInfoContent');

                if (currentOrder.device_password || currentOrder.pattern_password || currentOrder.device_power_on) {
                    let html = '';
                    if (currentOrder.device_password) {
                        html += `<div style="margin-bottom: 0.5rem;"><span style="color: var(--text-muted);">æ•°å­—/å­—æ¯å¯†ç ï¼š</span><span style="color: var(--accent-blue); font-family: monospace; font-size: 1.1rem;">${currentOrder.device_password}</span></div>`;
                    }
                    if (currentOrder.pattern_password) {
                        html += `<div style="margin-bottom: 0.5rem;"><span style="color: var(--text-muted);">å›¾æ¡ˆå¯†ç ï¼š</span><span style="color: var(--accent-purple); font-family: monospace; font-size: 1.1rem;">${formatPatternPassword(currentOrder.pattern_password)}</span></div>`;
                    }
                    if (currentOrder.device_power_on) {
                        html += `<div><span style="color: var(--text-muted);">è®¾å¤‡å¼€æœºï¼š</span><span style="color: ${currentOrder.device_power_on === 'æ˜¯' ? 'var(--accent-green)' : 'var(--accent-orange)'}; font-weight: 600; font-size: 1.1rem;">${currentOrder.device_power_on}</span></div>`;
                    }
                    passwordContent.innerHTML = html;
                    passwordSection.style.display = 'block';
                } else {
                    passwordSection.style.display = 'none';
                }

                // æ˜¾ç¤ºæ•…éšœæè¿°
                document.getElementById('problemContent').textContent = currentOrder.problem || 'æ— æè¿°';

                // è®¾ç½®è®¢è´§æ¸ é“
                const channel = currentOrder.order_channel || '';
                const channelSelect = document.getElementById('editOrderChannel');
                const customChannelInput = document.getElementById('editCustomChannel');

                if (channel && !['it-ricambi', '37smart', 'Amazon', ''].includes(channel)) {
                    channelSelect.value = 'å…¶å®ƒ';
                    customChannelInput.value = channel;
                    customChannelInput.style.display = 'block';
                } else {
                    channelSelect.value = channel;
                    customChannelInput.value = '';
                    customChannelInput.style.display = 'none';
                }

                // ç›‘å¬æ¸ é“å˜åŒ–
                channelSelect.onchange = function () {
                    customChannelInput.style.display = this.value === 'å…¶å®ƒ' ? 'block' : 'none';
                    if (this.value !== 'å…¶å®ƒ') customChannelInput.value = '';
                };

                openModal('editModal');
            } catch (error) {
                utils.showToast('åŠ è½½å¤±è´¥', 'error');
            }
        }

        // è·å–ç¼–è¾‘çš„è®¢è´§æ¸ é“
        function getEditOrderChannel() {
            const selected = document.getElementById('editOrderChannel').value;
            if (selected === 'å…¶å®ƒ') {
                return document.getElementById('editCustomChannel').value.trim() || 'å…¶å®ƒ';
            }
            return selected;
        }

        // ä¿å­˜ç¼–è¾‘
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('editOrderId').value;
            const data = {
                status: document.getElementById('editStatus').value,
                repair_notes: document.getElementById('editNotes').value,
                final_price: parseFloat(document.getElementById('editFinalPrice').value) || 0,
                order_channel: getEditOrderChannel(),
            };

            try {
                await API.orders.update(id, data);
                utils.showToast('ä¿å­˜æˆåŠŸ');
                closeModal('editModal');
                loadOrders();
            } catch (error) {
                utils.showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        });

        // æ‰“å°å½“å‰å·¥å•
        function printCurrentOrder() {
            if (currentOrder) {
                // æ›´æ–°å½“å‰æ•°æ®
                currentOrder.status = document.getElementById('editStatus').value;
                currentOrder.repair_notes = document.getElementById('editNotes').value;
                currentOrder.final_price = parseFloat(document.getElementById('editFinalPrice').value) || 0;
                utils.printOrder(currentOrder);
            }
        }

        // åˆå§‹åŒ–
        loadOrders();
    </script>
</body>

</html>