<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰å°çœ‹æ¿ - è¿ˆæ·æ‰‹æœºå†…éƒ¨æµç¨‹ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">
            <span class="logo">ğŸ“±</span>
            <h1>æ‰‹æœºç»´ä¿®ç®¡ç†</h1>
        </a>
        <ul class="navbar-menu">
            <li><a href="index.html">ğŸ  é¦–é¡µ</a></li>
            <li><a href="register.html">ğŸ“ ç™»è®°</a></li>
            <li><a href="front-desk.html" class="active">ğŸ“º å‰å°çœ‹æ¿</a></li>
            <li><a href="repair.html">ğŸ”§ ç»´ä¿®çœ‹æ¿</a></li>
            <li><a href="customers.html">ğŸ‘¥ å®¢æˆ·</a></li>
            <li><a href="pricing.html">ğŸ’° ä»·æ ¼ç®¡ç†</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h2>ğŸ“º å‰å°çœ‹æ¿</h2>
                <p>å®æ—¶æŸ¥çœ‹æ‰€æœ‰å·¥å•çŠ¶æ€ <span style="font-size: 0.85rem; color: var(--text-muted);">(å·²å®Œæˆä»…æ˜¾ç¤º3å¤©å†…)</span></p>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <a href="history.html" class="btn btn-ghost">ğŸ“‹ æŸ¥è¯¢ä»¥å¾€ç»´ä¿®è®°å½•</a>
                <div class="search-box">
                    <span>ğŸ”</span>
                    <input type="text" id="searchInput" placeholder="æœç´¢å·¥å•å·ã€å®¢æˆ·å§“åæˆ–ç”µè¯...">
                </div>
            </div>
        </div>

        <!-- çœ‹æ¿ -->
        <div class="kanban-container">
            <div class="kanban-column" data-status="ç­‰å¾…è®¢è´§">
                <div class="kanban-column-header">
                    <span>ğŸ“¦</span>
                    <span class="kanban-column-title">ç­‰å¾…è®¢è´§</span>
                    <span class="kanban-column-count" id="count-ç­‰å¾…è®¢è´§">0</span>
                </div>
                <div class="kanban-cards" id="cards-ç­‰å¾…è®¢è´§"></div>
            </div>

            <div class="kanban-column" data-status="å¾…ç»´ä¿®">
                <div class="kanban-column-header">
                    <span>â³</span>
                    <span class="kanban-column-title">å¾…ç»´ä¿®</span>
                    <span class="kanban-column-count" id="count-å¾…ç»´ä¿®">0</span>
                </div>
                <div class="kanban-cards" id="cards-å¾…ç»´ä¿®"></div>
            </div>

            <div class="kanban-column" data-status="ç»´ä¿®ä¸­">
                <div class="kanban-column-header">
                    <span>ğŸ”§</span>
                    <span class="kanban-column-title">ç»´ä¿®ä¸­</span>
                    <span class="kanban-column-count" id="count-ç»´ä¿®ä¸­">0</span>
                </div>
                <div class="kanban-cards" id="cards-ç»´ä¿®ä¸­"></div>
            </div>

            <div class="kanban-column" data-status="å¾…å–æœº">
                <div class="kanban-column-header">
                    <span>ğŸ“¦</span>
                    <span class="kanban-column-title">å¾…å–æœº</span>
                    <span class="kanban-column-count" id="count-å¾…å–æœº">0</span>
                </div>
                <div class="kanban-cards" id="cards-å¾…å–æœº"></div>
            </div>

            <div class="kanban-column" data-status="å·²å®Œæˆ">
                <div class="kanban-column-header">
                    <span>âœ…</span>
                    <span class="kanban-column-title">å·²å®Œæˆ</span>
                    <span class="kanban-column-count" id="count-å·²å®Œæˆ">0</span>
                </div>
                <div class="kanban-cards" id="cards-å·²å®Œæˆ"></div>
            </div>
        </div>
    </div>

    <!-- å·¥å•è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="orderModal">
        <div class="modal">
            <div class="modal-header">
                <h3>å·¥å•è¯¦æƒ…</h3>
                <button class="modal-close" onclick="closeModal('orderModal')">&times;</button>
            </div>
            <form id="orderEditForm">
                <div id="orderModalContent"></div>

                <!-- ç¼–è¾‘åŒºåŸŸ -->
                <div class="card" style="margin: 1rem; padding: 1rem; border: 2px solid var(--accent-orange);">
                    <div style="font-weight: 600; margin-bottom: 1rem; color: var(--accent-orange);">ğŸ“¦ è®¢è´§ä¸çŠ¶æ€ç¼–è¾‘</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">å½“å‰çŠ¶æ€</label>
                            <select class="form-control" id="editOrderStatus">
                                <option value="ç­‰å¾…è®¢è´§">ç­‰å¾…è®¢è´§</option>
                                <option value="å¾…ç»´ä¿®">å¾…ç»´ä¿®</option>
                                <option value="ç»´ä¿®ä¸­">ç»´ä¿®ä¸­</option>
                                <option value="å¾…å–æœº">å¾…å–æœº</option>
                                <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ğŸ›’ è®¢è´§æ¸ é“</label>
                            <select class="form-control" id="editOrderChannel"
                                onchange="toggleFrontDeskCustomChannel()">
                                <option value="">æ— </option>
                                <option value="it-ricambi">it-ricambi</option>
                                <option value="37smart">37smart</option>
                                <option value="Amazon">Amazon</option>
                                <option value="å…¶å®ƒ">å…¶å®ƒ</option>
                            </select>
                        </div>
                    </div>
                    <input type="text" class="form-control" id="editCustomChannel"
                        style="display: none; margin-top: 0.5rem;" placeholder="è¯·è¾“å…¥å…¶å®ƒæ¸ é“åç§°...">
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-ghost" onclick="closeModal('orderModal')">å…³é—­</button>
                    <button type="button" class="btn btn-warning" id="printOrderBtn">ğŸ–¨ï¸ æ‰“å°</button>
                    <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script>
        let allOrders = [];
        let currentOrder = null;
        let draggedCard = null;

        // æ ¼å¼åŒ–å›¾æ¡ˆå¯†ç æ˜¾ç¤º
        function formatPatternPassword(pattern) {
            if (!pattern) return '';
            return pattern.split(',').map(i => parseInt(i) + 1).join(' â†’ ');
        }

        // è®¾ç½®æ‹–æ‹½
        function setupDragAndDrop(container) {
            const cards = container.querySelectorAll('.order-card');

            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    draggedCard = card;
                    card.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                    draggedCard = null;
                    document.querySelectorAll('.kanban-cards').forEach(c => c.classList.remove('drag-over'));
                });
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                container.classList.add('drag-over');
            });

            container.addEventListener('dragleave', () => {
                container.classList.remove('drag-over');
            });

            container.addEventListener('drop', async (e) => {
                e.preventDefault();
                container.classList.remove('drag-over');

                if (!draggedCard) return;

                const newStatus = container.closest('.kanban-column').dataset.status;
                const orderId = parseInt(draggedCard.dataset.id);
                const oldStatus = draggedCard.dataset.status;

                if (newStatus !== oldStatus) {
                    try {
                        await API.orders.updateStatus(orderId, newStatus);
                        utils.showToast(`çŠ¶æ€å·²æ›´æ–°ä¸º"${newStatus}"`);
                        loadOrders();
                    } catch (error) {
                        utils.showToast('æ›´æ–°å¤±è´¥', 'error');
                    }
                }
            });
        }

        // åŠ è½½å·¥å•
        async function loadOrders(search = '') {
            try {
                const params = search ? { search } : {};
                allOrders = await API.orders.getAll(params);
                renderKanban();
            } catch (error) {
                console.error('åŠ è½½å·¥å•å¤±è´¥:', error);
                utils.showToast('åŠ è½½å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“çœ‹æ¿
        function renderKanban() {
            const statuses = ['ç­‰å¾…è®¢è´§', 'å¾…ç»´ä¿®', 'ç»´ä¿®ä¸­', 'å¾…å–æœº', 'å·²å®Œæˆ'];
            const threeDaysAgo = new Date();
            threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);

            statuses.forEach(status => {
                const container = document.getElementById(`cards-${status}`);
                const countEl = document.getElementById(`count-${status}`);

                // å·²å®Œæˆçš„å·¥å•åªæ˜¾ç¤º3å¤©å†…çš„
                let orders = allOrders.filter(o => o.status === status);
                if (status === 'å·²å®Œæˆ') {
                    orders = orders.filter(o => new Date(o.created_at) >= threeDaysAgo);
                }

                countEl.textContent = orders.length;

                if (orders.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>æš‚æ— å·¥å•</p></div>';
                } else {
                    container.innerHTML = orders.map(order => `
                        <div class="order-card fade-in" draggable="true" data-id="${order.id}" data-status="${order.status}">
                            <div class="order-card-header">
                                <span class="order-no">${order.order_no}</span>
                                <span class="order-time">${utils.formatDate(order.created_at)}</span>
                            </div>
                            <div class="order-device">${order.device_brand} ${order.device_model}</div>
                            <div class="order-problem">${order.problem}</div>
                            ${order.order_channel ? `<div style="margin-top: 0.5rem;"><span style="background: linear-gradient(135deg, rgba(245, 87, 108, 0.2), rgba(240, 147, 251, 0.2)); color: var(--accent-orange); padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.75rem;">ğŸ›’ ${order.order_channel}</span></div>` : ''}
                            <div class="order-customer">
                                <span>ğŸ‘¤ ${order.customer_name || '-'}</span>
                                <span class="order-price">${utils.formatPrice(order.estimated_price)}</span>
                            </div>
                        </div>
                    `).join('');
                }

                setupDragAndDrop(container);
            });

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.order-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.dragging')) {
                        showOrderDetail(parseInt(card.dataset.id));
                    }
                });
            });
        }

        // æ˜¾ç¤ºå·¥å•è¯¦æƒ…
        async function showOrderDetail(id) {
            try {
                currentOrder = await API.orders.getById(id);
                const content = document.getElementById('orderModalContent');

                content.innerHTML = `
                    <div style="display: grid; gap: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: var(--accent-purple);">${currentOrder.order_no}</div>
                                <div style="color: var(--text-muted); font-size: 0.9rem;">åˆ›å»ºäº ${utils.formatDate(currentOrder.created_at)}</div>
                            </div>
                            <span class="status-badge ${currentOrder.status}">${currentOrder.status}</span>
                        </div>

                        <div class="card" style="margin: 0; padding: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">ğŸ‘¤ å®¢æˆ·ä¿¡æ¯</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
                                <div><span style="color: var(--text-muted);">å§“åï¼š</span>${currentOrder.customer_name || '-'}</div>
                                <div><span style="color: var(--text-muted);">ç”µè¯ï¼š</span>${currentOrder.customer_phone || '-'}</div>
                            </div>
                        </div>

                        <div class="card" style="margin: 0; padding: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">ğŸ“± è®¾å¤‡ä¿¡æ¯</div>
                            <div style="font-size: 0.9rem;">
                                <div><span style="color: var(--text-muted);">å“ç‰Œå‹å·ï¼š</span>${currentOrder.device_brand} ${currentOrder.device_model}</div>
                                ${currentOrder.device_password ? `<div style="margin-top: 0.5rem;"><span style="color: var(--text-muted);">ğŸ” è®¾å¤‡å¯†ç ï¼š</span><span style="color: var(--accent-blue); font-family: monospace;">${currentOrder.device_password}</span></div>` : ''}
                                ${currentOrder.pattern_password ? `<div style="margin-top: 0.5rem;"><span style="color: var(--text-muted);">ğŸ“ å›¾æ¡ˆå¯†ç ï¼š</span><span style="color: var(--accent-purple); font-family: monospace;">${formatPatternPassword(currentOrder.pattern_password)}</span></div>` : ''}
                                ${currentOrder.device_power_on ? `<div style="margin-top: 0.5rem;"><span style="color: var(--text-muted);">ğŸ“± è®¾å¤‡å¼€æœºï¼š</span><span style="color: ${currentOrder.device_power_on === 'æ˜¯' ? 'var(--accent-green)' : 'var(--accent-orange)'}; font-weight: 600;">${currentOrder.device_power_on}</span></div>` : ''}
                                <div style="margin-top: 0.5rem;"><span style="color: var(--text-muted);">æ•…éšœæè¿°ï¼š</span></div>
                                <div style="padding: 0.75rem; background: var(--bg-glass); border-radius: var(--radius-sm); margin-top: 0.25rem;">
                                    ${currentOrder.problem}
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin: 0; padding: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">ğŸ’° è´¹ç”¨ä¿¡æ¯</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
                                <div><span style="color: var(--text-muted);">é¢„ä¼°ä»·æ ¼ï¼š</span><span style="color: var(--accent-green);">${utils.formatPrice(currentOrder.estimated_price)}</span></div>
                                <div><span style="color: var(--text-muted);">æŠ¼é‡‘ï¼š</span><span style="color: var(--accent-blue);">${utils.formatPrice(currentOrder.deposit || 0)}</span></div>
                                <div><span style="color: var(--text-muted);">åº”æ”¶ï¼š</span><span style="color: var(--accent-purple); font-weight: 600;">${utils.formatPrice((currentOrder.estimated_price || 0) - (currentOrder.deposit || 0))}</span></div>
                                <div><span style="color: var(--text-muted);">å®é™…ä»·æ ¼ï¼š</span><span style="color: var(--accent-green);">${utils.formatPrice(currentOrder.final_price)}</span></div>
                                <div><span style="color: var(--text-muted);">é¢„è®¡å®Œæˆï¼š</span>${currentOrder.estimated_date || '-'}</div>
                            </div>
                        </div>

                        ${currentOrder.repair_notes ? `
                        <div class="card" style="margin: 0; padding: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">ğŸ“ ç»´ä¿®å¤‡æ³¨</div>
                            <div style="padding: 0.75rem; background: var(--bg-glass); border-radius: var(--radius-sm); font-size: 0.9rem;">
                                ${currentOrder.repair_notes}
                            </div>
                        </div>
                        ` : ''}

                        ${currentOrder.order_channel ? `
                        <div class="card" style="margin: 0; padding: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">ğŸ“¦ è®¢è´§ä¿¡æ¯</div>
                            <div style="font-size: 0.9rem;">
                                <span style="color: var(--text-muted);">è®¢è´§æ¸ é“ï¼š</span>
                                <span style="color: var(--accent-orange); font-weight: 600;">${currentOrder.order_channel}</span>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;

                // è®¾ç½®ç¼–è¾‘åŒºåŸŸçš„å€¼
                document.getElementById('editOrderStatus').value = currentOrder.status;

                // è®¾ç½®è®¢è´§æ¸ é“
                const channel = currentOrder.order_channel || '';
                const channelSelect = document.getElementById('editOrderChannel');
                const customInput = document.getElementById('editCustomChannel');

                if (channel && !['it-ricambi', '37smart', 'Amazon', ''].includes(channel)) {
                    channelSelect.value = 'å…¶å®ƒ';
                    customInput.value = channel;
                    customInput.style.display = 'block';
                } else {
                    channelSelect.value = channel;
                    customInput.value = '';
                    customInput.style.display = 'none';
                }

                openModal('orderModal');
            } catch (error) {
                utils.showToast('åŠ è½½è¯¦æƒ…å¤±è´¥', 'error');
            }
        }

        // æ‰“å°å·¥å•
        document.getElementById('printOrderBtn').addEventListener('click', () => {
            if (currentOrder) {
                utils.printOrder(currentOrder);
            }
        });

        // åˆ‡æ¢è‡ªå®šä¹‰æ¸ é“è¾“å…¥æ¡†
        function toggleFrontDeskCustomChannel() {
            const selected = document.getElementById('editOrderChannel').value;
            const customInput = document.getElementById('editCustomChannel');
            customInput.style.display = selected === 'å…¶å®ƒ' ? 'block' : 'none';
            if (selected !== 'å…¶å®ƒ') customInput.value = '';
        }

        // è·å–ç¼–è¾‘çš„è®¢è´§æ¸ é“
        function getEditedChannel() {
            const selected = document.getElementById('editOrderChannel').value;
            if (selected === 'å…¶å®ƒ') {
                return document.getElementById('editCustomChannel').value.trim() || 'å…¶å®ƒ';
            }
            return selected;
        }

        // ä¿å­˜ç¼–è¾‘
        document.getElementById('orderEditForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentOrder) return;

            const data = {
                status: document.getElementById('editOrderStatus').value,
                order_channel: getEditedChannel(),
            };

            try {
                await API.orders.update(currentOrder.id, data);
                utils.showToast('ä¿å­˜æˆåŠŸ');
                closeModal('orderModal');
                loadOrders();
            } catch (error) {
                utils.showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        });

        // æœç´¢
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadOrders(e.target.value.trim());
            }, 300);
        });

        // è‡ªåŠ¨åˆ·æ–°
        setInterval(() => loadOrders(), 30000);

        // åˆå§‹åŒ–
        loadOrders();
    </script>
</body>

</html>