<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»è®°å·¥å• - è¿ˆæ·æ‰‹æœºå†…éƒ¨æµç¨‹ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">
            <span class="logo">ğŸ“±</span>
            <h1>æ‰‹æœºç»´ä¿®ç®¡ç†</h1>
        </a>
        <ul class="navbar-menu">
            <li><a href="index.html">ğŸ  é¦–é¡µ</a></li>
            <li><a href="register.html" class="active">ğŸ“ ç™»è®°</a></li>
            <li><a href="front-desk.html">ğŸ“º å‰å°çœ‹æ¿</a></li>
            <li><a href="repair.html">ğŸ”§ ç»´ä¿®çœ‹æ¿</a></li>
            <li><a href="customers.html">ğŸ‘¥ å®¢æˆ·</a></li>
            <li><a href="pricing.html">ğŸ’° ä»·æ ¼ç®¡ç†</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-header">
            <h2>ğŸ“ æ–°å»ºå·¥å•</h2>
            <p>ç™»è®°å®¢æˆ·è®¾å¤‡ç»´ä¿®ä¿¡æ¯</p>
        </div>

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
            <!-- ç™»è®°è¡¨å• -->
            <div class="card">
                <!-- OCR æ‰«æåŒºåŸŸ -->
                <div class="card-header" style="border-bottom: none; padding-bottom: 0;">
                    <h3 class="card-title">ğŸ“· æ‹ç…§è¯†åˆ« (å¯é€‰)</h3>
                </div>
                <div
                    style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-glass); border-radius: var(--radius-md); border: 1px dashed var(--border-glass);">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <input type="file" id="ocrImageInput" accept="image/*" capture="environment"
                            style="display: none;">
                        <button type="button" class="btn btn-ghost"
                            onclick="document.getElementById('ocrImageInput').click()">
                            ğŸ“· æ‹ç…§/é€‰æ‹©å›¾ç‰‡
                        </button>
                        <button type="button" class="btn btn-primary" id="ocrRecognizeBtn" style="display: none;"
                            onclick="recognizeImage()">
                            ğŸ” è¯†åˆ«æ‰‹å†™å†…å®¹
                        </button>
                        <span id="ocrFileName" style="font-size: 0.85rem; color: var(--text-muted);"></span>
                    </div>
                    <div id="ocrPreview" style="display: none; margin-top: 1rem;">
                        <img id="ocrPreviewImg"
                            style="max-width: 100%; max-height: 200px; border-radius: var(--radius-sm);">
                    </div>
                    <div id="ocrStatus"
                        style="display: none; margin-top: 1rem; padding: 0.75rem; background: rgba(102, 126, 234, 0.1); border-radius: var(--radius-sm); font-size: 0.9rem;">
                        <span class="loading">ğŸ”„ æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...</span>
                    </div>
                </div>

                <form id="registerForm">
                    <!-- å®¢æˆ·ä¿¡æ¯ -->
                    <div class="card-header">
                        <h3 class="card-title">ğŸ‘¤ å®¢æˆ·ä¿¡æ¯</h3>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">å®¢æˆ·å§“å</label>
                            <input type="text" class="form-control" id="customerName" placeholder="è¯·è¾“å…¥å§“å">
                        </div>
                        <div class="form-group">
                            <label class="form-label">è”ç³»ç”µè¯</label>
                            <input type="tel" class="form-control" id="customerPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
                            <button type="button" class="btn btn-sm btn-ghost" style="margin-top: 0.5rem;"
                                onclick="searchCustomer()">
                                ğŸ” æŸ¥è¯¢å†å²
                            </button>
                        </div>
                    </div>


                    <!-- è®¾å¤‡ä¿¡æ¯ä¸ç»´ä¿®é¡¹ç›® (æ•´åˆ) -->
                    <div class="card-header" style="margin-top: 1rem;">
                        <h3 class="card-title">ğŸ“± è®¾å¤‡ä¿¡æ¯ä¸ç»´ä¿®é¡¹ç›®</h3>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">è®¾å¤‡å“ç‰Œ *</label>
                            <select class="form-control" id="deviceBrand" required onchange="onDeviceBrandChange()">
                                <option value="">é€‰æ‹©å“ç‰Œ</option>
                                <!-- åŠ¨æ€åŠ è½½å“ç‰Œ -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">è®¾å¤‡å‹å· *</label>
                            <div style="position: relative;">
                                <select class="form-control" id="deviceModelSelect"
                                    onchange="onDeviceModelSelectChange()" style="margin-bottom: 0.5rem;">
                                    <option value="">é€‰æ‹©å‹å·æˆ–æ‰‹åŠ¨è¾“å…¥</option>
                                </select>
                                <input type="text" class="form-control" id="deviceModel" required
                                    placeholder="è¾“å…¥å‹å· (å¦‚ï¼šiPhone 15 Pro)" oninput="onDeviceModelInputChange()">
                            </div>
                        </div>
                    </div>

                    <!-- å¯é€‰ç»´ä¿®é¡¹ç›® -->
                    <div class="form-group">
                        <label class="form-label">å¯é€‰ç»´ä¿®é¡¹ç›® <span
                                style="font-size: 0.85rem; color: var(--text-muted);">(ç‚¹å‡»æ·»åŠ åˆ°æ•…éšœæè¿°)</span></label>
                        <div id="repairOptionsContainer"
                            style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; min-height: 40px; padding: 0.75rem; background: var(--bg-glass); border-radius: var(--radius-md); border: 1px dashed var(--border-glass);">
                            <span style="color: var(--text-muted); font-size: 0.9rem;">è¯·å…ˆé€‰æ‹©è®¾å¤‡å“ç‰Œå’Œå‹å·</span>
                        </div>
                    </div>

                    <!-- è®¾å¤‡å¯†ç ä¿¡æ¯ -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ğŸ” è®¾å¤‡å¯†ç </label>
                            <input type="text" class="form-control" id="devicePassword" placeholder="è¾“å…¥æ•°å­—/å­—æ¯å¯†ç ">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ğŸ“ ä¹å®«æ ¼å›¾æ¡ˆå¯†ç </label>
                            <div class="pattern-lock-container">
                                <div class="pattern-lock" id="patternLock">
                                    <svg class="pattern-line" id="patternSvg"></svg>
                                    <div class="pattern-dot" data-index="0"></div>
                                    <div class="pattern-dot" data-index="1"></div>
                                    <div class="pattern-dot" data-index="2"></div>
                                    <div class="pattern-dot" data-index="3"></div>
                                    <div class="pattern-dot" data-index="4"></div>
                                    <div class="pattern-dot" data-index="5"></div>
                                    <div class="pattern-dot" data-index="6"></div>
                                    <div class="pattern-dot" data-index="7"></div>
                                    <div class="pattern-dot" data-index="8"></div>
                                </div>
                                <div class="pattern-actions">
                                    <span class="pattern-result" id="patternResult">æœªè®¾ç½®</span>
                                    <button type="button" class="btn btn-sm btn-ghost"
                                        onclick="clearPattern()">æ¸…é™¤</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è®¾å¤‡çŠ¶æ€ -->
                    <div class="form-group">
                        <label class="form-label">ğŸ“± è®¾å¤‡æ˜¯å¦å¼€æœº</label>
                        <div style="display: flex; gap: 1.5rem; margin-top: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="devicePowerOn" value="æ˜¯"
                                    style="width: 18px; height: 18px; accent-color: var(--accent-green);">
                                <span style="color: var(--accent-green);">âœ“ æ˜¯</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="devicePowerOn" value="å¦"
                                    style="width: 18px; height: 18px; accent-color: var(--accent-orange);">
                                <span style="color: var(--accent-orange);">âœ— å¦</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="devicePowerOn" value="" checked
                                    style="width: 18px; height: 18px;">
                                <span style="color: var(--text-muted);">æœªçŸ¥</span>
                            </label>
                        </div>
                    </div>

                    <!-- æ˜¯å¦éœ€è¦è®¢è´§ -->
                    <div class="form-group">
                        <label class="form-label">ğŸ“¦ æ˜¯å¦éœ€è¦è®¢è´§</label>
                        <div style="display: flex; gap: 1.5rem; margin-top: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="needsOrdering" value="æ˜¯" onchange="toggleOrderChannel()"
                                    style="width: 18px; height: 18px; accent-color: var(--accent-orange);">
                                <span style="color: var(--accent-orange);">ğŸ“¦ æ˜¯</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="needsOrdering" value="å¦" checked
                                    onchange="toggleOrderChannel()"
                                    style="width: 18px; height: 18px; accent-color: var(--accent-green);">
                                <span style="color: var(--accent-green);">âœ“ å¦</span>
                            </label>
                        </div>
                    </div>

                    <!-- è®¢è´§æ¸ é“ (ä»…åœ¨éœ€è¦è®¢è´§æ—¶æ˜¾ç¤º) -->
                    <div class="form-group" id="orderChannelGroup" style="display: none;">
                        <label class="form-label">ğŸ›’ è®¢è´§æ¸ é“</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="orderChannel" value="it-ricambi"
                                    style="width: 18px; height: 18px; accent-color: var(--accent-blue);">
                                <span>it-ricambi</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="orderChannel" value="37smart"
                                    style="width: 18px; height: 18px; accent-color: var(--accent-blue);">
                                <span>37smart</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="orderChannel" value="Amazon"
                                    style="width: 18px; height: 18px; accent-color: var(--accent-blue);">
                                <span>Amazon</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="orderChannel" value="å…¶å®ƒ" onchange="toggleCustomChannel()"
                                    style="width: 18px; height: 18px; accent-color: var(--accent-purple);">
                                <span>å…¶å®ƒ</span>
                            </label>
                        </div>
                        <input type="text" class="form-control" id="customOrderChannel"
                            style="display: none; margin-top: 0.5rem;" placeholder="è¯·è¾“å…¥å…¶å®ƒæ¸ é“åç§°...">
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ•…éšœæè¿° *</label>
                        <textarea class="form-control" id="problem" required placeholder="è¯·è¯¦ç»†æè¿°è®¾å¤‡é—®é¢˜..."></textarea>
                    </div>

                    <!-- è´¹ç”¨ä¿¡æ¯ -->
                    <div class="card-header" style="margin-top: 1rem;">
                        <h3 class="card-title">ğŸ’° è´¹ç”¨é¢„ä¼°</h3>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">é¢„ä¼°ä»·æ ¼</label>
                            <div class="price-input">
                                <input type="number" class="form-control" id="estimatedPrice" placeholder="0.00"
                                    step="0.01" min="0" oninput="updateAmountDue()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æŠ¼é‡‘</label>
                            <div class="price-input">
                                <input type="number" class="form-control" id="deposit" placeholder="0.00" step="0.01"
                                    min="0" oninput="updateAmountDue()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">åº”æ”¶</label>
                            <div
                                style="padding: 0.875rem 1rem; background: var(--bg-glass); border: 1px solid var(--border-glass); border-radius: var(--radius-md); font-size: 1.1rem; font-weight: 600; color: var(--accent-green);">
                                â‚¬<span id="amountDue">0.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">é¢„è®¡å®Œæˆæ—¥æœŸ</label>
                            <input type="date" class="form-control" id="estimatedDate">
                        </div>
                    </div>

                    <!-- å·²é€‰é¡¹ç›® -->
                    <div id="selectedItems" style="display: none;">
                        <label class="form-label">å·²é€‰é¡¹ç›®</label>
                        <div id="selectedItemsList" style="margin-top: 0.5rem;"></div>
                    </div>

                    <div style="margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary btn-block">
                            âœ“ æäº¤å·¥å•
                        </button>
                    </div>
                </form>
            </div>

            <!-- å³ä¾§é¢æ¿ -->
            <div>
                <!-- å®¢æˆ·å†å² -->
                <div class="card" id="customerHistory" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“‹ å®¢æˆ·å†å²</h3>
                    </div>
                    <div id="customerHistoryContent"></div>
                </div>

            </div>
        </div>

        <script src="js/api.js"></script>
        <script src="js/app.js"></script>
        <script>
            let selectedItems = [];
            let patternSequence = [];
            let isDrawing = false;
            let selectedOcrFile = null;

            // =============== OCR å›¾ç‰‡è¯†åˆ«åŠŸèƒ½ ===============
            document.getElementById('ocrImageInput').addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (!file) return;

                selectedOcrFile = file;
                document.getElementById('ocrFileName').textContent = file.name;
                document.getElementById('ocrRecognizeBtn').style.display = 'inline-flex';

                // æ˜¾ç¤ºé¢„è§ˆ
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('ocrPreviewImg').src = e.target.result;
                    document.getElementById('ocrPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            });

            // è¯†åˆ«å›¾ç‰‡
            async function recognizeImage() {
                if (!selectedOcrFile) {
                    utils.showToast('è¯·å…ˆé€‰æ‹©å›¾ç‰‡', 'error');
                    return;
                }

                const statusEl = document.getElementById('ocrStatus');
                statusEl.style.display = 'block';
                statusEl.innerHTML = '<span class="loading">ğŸ”„ æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...</span>';

                try {
                    const result = await API.ocr.recognize(selectedOcrFile);

                    if (result.success && result.data) {
                        const data = result.data;

                        // è‡ªåŠ¨å¡«å……è¡¨å•å­—æ®µ
                        if (data.customer_name) {
                            document.getElementById('customerName').value = data.customer_name;
                        }
                        if (data.customer_phone) {
                            document.getElementById('customerPhone').value = data.customer_phone;
                        }
                        if (data.device_brand) {
                            // å°è¯•åŒ¹é…ä¸‹æ‹‰èœå•ä¸­çš„å€¼
                            const brandSelect = document.getElementById('deviceBrand');
                            const options = Array.from(brandSelect.options);
                            const matchedOption = options.find(opt =>
                                opt.value.toLowerCase() === data.device_brand.toLowerCase()
                            );
                            if (matchedOption) {
                                brandSelect.value = matchedOption.value;
                            } else {
                                brandSelect.value = 'å…¶ä»–';
                            }
                        }
                        if (data.device_model) {
                            document.getElementById('deviceModel').value = data.device_model;
                        }
                        if (data.problem) {
                            document.getElementById('problem').value = data.problem;
                        }
                        if (data.estimated_price && !isNaN(parseFloat(data.estimated_price))) {
                            document.getElementById('estimatedPrice').value = parseFloat(data.estimated_price);
                        }

                        statusEl.innerHTML = '<span style="color: var(--accent-green);">âœ… è¯†åˆ«æˆåŠŸï¼å·²è‡ªåŠ¨å¡«å……è¡¨å•</span>';
                        utils.showToast('è¯†åˆ«æˆåŠŸï¼Œå·²è‡ªåŠ¨å¡«å……è¡¨å•');
                    } else {
                        statusEl.innerHTML = `<span style="color: var(--accent-orange);">âš ï¸ è¯†åˆ«å®Œæˆä½†æ— æ³•è§£æï¼š${result.raw_content || 'æœªçŸ¥ç»“æœ'}</span>`;
                        utils.showToast('è¯†åˆ«å®Œæˆä½†æ— æ³•è‡ªåŠ¨å¡«å……', 'error');
                    }
                } catch (error) {
                    statusEl.innerHTML = `<span style="color: var(--accent-orange);">âŒ è¯†åˆ«å¤±è´¥ï¼š${error.message}</span>`;
                    utils.showToast('è¯†åˆ«å¤±è´¥ï¼š' + error.message, 'error');
                }
            }

            // æ›´æ–°åº”æ”¶é‡‘é¢
            function updateAmountDue() {
                const estimatedPrice = parseFloat(document.getElementById('estimatedPrice').value) || 0;
                const deposit = parseFloat(document.getElementById('deposit').value) || 0;
                const amountDue = Math.max(0, estimatedPrice - deposit);
                document.getElementById('amountDue').textContent = amountDue.toFixed(2);
            }

            // åŠ è½½å“ç‰Œåˆ—è¡¨åˆ°è®¾å¤‡å“ç‰Œä¸‹æ‹‰æ¡†
            let allBrands = [];
            let availableItems = [];

            async function loadDeviceBrands() {
                try {
                    allBrands = await API.pricing.getBrands();
                    const brandSelect = document.getElementById('deviceBrand');
                    brandSelect.innerHTML = '<option value="">é€‰æ‹©å“ç‰Œ</option>' +
                        allBrands.map(brand => `<option value="${brand}">${brand}</option>`).join('') +
                        '<option value="å…¶ä»–">å…¶ä»–</option>';
                } catch (error) {
                    console.error('åŠ è½½å“ç‰Œå¤±è´¥:', error);
                    // å¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å“ç‰Œåˆ—è¡¨
                    const brandSelect = document.getElementById('deviceBrand');
                    brandSelect.innerHTML = `
                    <option value="">é€‰æ‹©å“ç‰Œ</option>
                    <option value="Apple">Apple</option>
                    <option value="Samsung">Samsung</option>
                    <option value="Huawei">Huawei</option>
                    <option value="Xiaomi">Xiaomi</option>
                    <option value="OPPO">OPPO</option>
                    <option value="vivo">vivo</option>
                    <option value="OnePlus">OnePlus</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                `;
                }
            }

            // è®¾å¤‡å“ç‰Œæ”¹å˜æ—¶
            async function onDeviceBrandChange() {
                const brand = document.getElementById('deviceBrand').value;
                const modelSelect = document.getElementById('deviceModelSelect');
                const modelInput = document.getElementById('deviceModel');
                const repairContainer = document.getElementById('repairOptionsContainer');

                // é‡ç½®å‹å·
                modelSelect.innerHTML = '<option value="">é€‰æ‹©å‹å·æˆ–æ‰‹åŠ¨è¾“å…¥</option>';
                modelInput.value = '';
                repairContainer.innerHTML = '<span style="color: var(--text-muted); font-size: 0.9rem;">è¯·å…ˆé€‰æ‹©è®¾å¤‡å“ç‰Œå’Œå‹å·</span>';

                if (!brand || brand === 'å…¶ä»–') {
                    // å¦‚æœé€‰æ‹©"å…¶ä»–"ï¼Œåªå…è®¸æ‰‹åŠ¨è¾“å…¥
                    return;
                }

                try {
                    const models = await API.pricing.getModelsByBrand(brand);
                    modelSelect.innerHTML = '<option value="">é€‰æ‹©å‹å·æˆ–æ‰‹åŠ¨è¾“å…¥</option>' +
                        models.map(model => `<option value="${model}">${model}</option>`).join('');
                } catch (error) {
                    console.error('åŠ è½½å‹å·å¤±è´¥:', error);
                }
            }

            // å‹å·ä¸‹æ‹‰é€‰æ‹©æ”¹å˜æ—¶
            function onDeviceModelSelectChange() {
                const selectedModel = document.getElementById('deviceModelSelect').value;
                const modelInput = document.getElementById('deviceModel');

                if (selectedModel) {
                    modelInput.value = selectedModel;
                    loadRepairOptions();
                }
            }

            // å‹å·æ‰‹åŠ¨è¾“å…¥æ”¹å˜æ—¶
            function onDeviceModelInputChange() {
                // å»¶è¿ŸåŠ è½½ç»´ä¿®é€‰é¡¹ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
                clearTimeout(window.modelInputTimeout);
                window.modelInputTimeout = setTimeout(() => {
                    loadRepairOptions();
                }, 500);
            }

            // åŠ è½½ç»´ä¿®é€‰é¡¹
            async function loadRepairOptions() {
                const brand = document.getElementById('deviceBrand').value;
                const model = document.getElementById('deviceModel').value.trim();
                const repairContainer = document.getElementById('repairOptionsContainer');

                if (!brand || !model) {
                    repairContainer.innerHTML = '<span style="color: var(--text-muted); font-size: 0.9rem;">è¯·å…ˆé€‰æ‹©è®¾å¤‡å“ç‰Œå’Œå‹å·</span>';
                    return;
                }

                try {
                    availableItems = await API.pricing.getItemsByBrandModel(brand, model);

                    if (availableItems.length === 0) {
                        repairContainer.innerHTML = '<span style="color: var(--text-muted); font-size: 0.9rem;">æ— å¯ç”¨ç»´ä¿®é¡¹ç›®ï¼Œè¯·æ‰‹åŠ¨å¡«å†™æ•…éšœæè¿°</span>';
                        return;
                    }

                    repairContainer.innerHTML = availableItems.map((item, index) => {
                        const categoryDisplay = item.name_it ? `${item.category} / ${item.name_it}` : item.category;
                        return `
                        <button type="button" class="tag repair-option-btn" onclick="addRepairToProblem(${index})" 
                            style="cursor: pointer; transition: all 0.2s ease;">
                            ${categoryDisplay} â‚¬${item.price}
                        </button>
                    `;
                    }).join('');

                } catch (error) {
                    console.error('åŠ è½½ç»´ä¿®é¡¹ç›®å¤±è´¥:', error);
                    repairContainer.innerHTML = '<span style="color: var(--text-muted); font-size: 0.9rem;">æ— å¯ç”¨ç»´ä¿®é¡¹ç›®ï¼Œè¯·æ‰‹åŠ¨å¡«å†™æ•…éšœæè¿°</span>';
                }
            }

            // ç‚¹å‡»ç»´ä¿®é€‰é¡¹ï¼Œæ·»åŠ åˆ°æ•…éšœæè¿°å’Œä»·æ ¼
            function addRepairToProblem(index) {
                const item = availableItems[index];
                const brand = document.getElementById('deviceBrand').value;
                const model = document.getElementById('deviceModel').value.trim();
                const problemTextarea = document.getElementById('problem');
                const estimatedPriceInput = document.getElementById('estimatedPrice');

                // æ„å»ºæ˜¾ç¤ºæ–‡æœ¬
                const categoryDisplay = item.name_it ? `${item.category} / ${item.name_it}` : item.category;
                const repairText = `${brand} ${model} - ${categoryDisplay}`;

                // æ·»åŠ åˆ°æ•…éšœæè¿°
                const currentProblem = problemTextarea.value.trim();
                if (currentProblem) {
                    problemTextarea.value = currentProblem + '\n' + repairText;
                } else {
                    problemTextarea.value = repairText;
                }

                // æ·»åŠ åˆ°é¢„ä¼°ä»·æ ¼
                const currentPrice = parseFloat(estimatedPriceInput.value) || 0;
                estimatedPriceInput.value = (currentPrice + item.price).toFixed(2);
                updateAmountDue();

                // æ·»åŠ åˆ°å·²é€‰é¡¹ç›®åˆ—è¡¨
                if (!selectedItems.find(i => i.pricing_id === item.id)) {
                    selectedItems.push({
                        pricing_id: item.id,
                        name: repairText,
                        price: item.price,
                        quantity: 1
                    });
                    updateSelectedItems();
                }

                // è§†è§‰åé¦ˆ
                utils.showToast(`å·²æ·»åŠ : ${categoryDisplay} â‚¬${item.price}`);
            }

            // æ›´æ–°å·²é€‰é¡¹ç›®æ˜¾ç¤º
            function updateSelectedItems() {
                const container = document.getElementById('selectedItems');
                const list = document.getElementById('selectedItemsList');

                if (selectedItems.length === 0) {
                    container.style.display = 'none';
                    return;
                }

                container.style.display = 'block';
                list.innerHTML = selectedItems.map((item, index) => `
                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--bg-glass); border-radius: var(--radius-sm); margin-bottom: 0.5rem;">
                    <span style="flex: 1;">${item.name}</span>
                    <span style="color: var(--accent-green);">â‚¬${item.price}</span>
                    <button type="button" class="btn btn-sm btn-ghost" onclick="removeItem(${index})">âœ•</button>
                </div>
            `).join('');
            }

            // ç§»é™¤é¡¹ç›®
            function removeItem(index) {
                const item = selectedItems[index];
                const btn = document.getElementById(`item-${item.pricing_id}`);
                if (btn) {
                    btn.style.background = '';
                    btn.style.borderColor = '';
                }
                selectedItems.splice(index, 1);
                updateSelectedItems();
                updateTotalPrice();
            }

            // æ›´æ–°æ€»ä»·
            function updateTotalPrice() {
                const total = selectedItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
                if (total > 0 && !document.getElementById('estimatedPrice').value) {
                    document.getElementById('estimatedPrice').value = total.toFixed(2);
                }
            }

            // æŸ¥è¯¢å®¢æˆ·å†å²
            async function searchCustomer() {
                const phone = document.getElementById('customerPhone').value.trim();
                if (!phone) {
                    utils.showToast('è¯·è¾“å…¥æ‰‹æœºå·', 'error');
                    return;
                }

                try {
                    const customer = await API.customers.getByPhone(phone);
                    document.getElementById('customerName').value = customer.name;

                    const container = document.getElementById('customerHistory');
                    const content = document.getElementById('customerHistoryContent');

                    container.style.display = 'block';
                    content.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <div style="font-weight: 600;">${customer.name}</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">${customer.phone}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;">
                            å…± ${customer.total_orders} æ¬¡ç»´ä¿® | æ¶ˆè´¹ â‚¬${customer.total_spent.toFixed(2)}
                        </div>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${customer.orders.map(order => `
                            <div style="padding: 0.75rem; background: var(--bg-glass); border-radius: var(--radius-sm); margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 0.85rem; color: var(--accent-purple);">${order.order_no}</span>
                                    <span class="status-badge ${order.status}" style="font-size: 0.7rem;">${order.status}</span>
                                </div>
                                <div style="font-size: 0.85rem; margin-top: 0.25rem;">${order.device_brand} ${order.device_model}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">${order.problem.substring(0, 30)}...</div>
                            </div>
                        `).join('')}
                    </div>
                `;

                    utils.showToast('æ‰¾åˆ°å®¢æˆ·å†å²è®°å½•');
                } catch (error) {
                    document.getElementById('customerHistory').style.display = 'none';
                    if (error.message.includes('ä¸å­˜åœ¨')) {
                        utils.showToast('æ–°å®¢æˆ·ï¼Œæ— å†å²è®°å½•', 'error');
                    } else {
                        utils.showToast('æŸ¥è¯¢å¤±è´¥', 'error');
                    }
                }
            }

            // è¡¨å•æäº¤
            document.getElementById('registerForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const needsOrdering = document.querySelector('input[name="needsOrdering"]:checked')?.value === 'æ˜¯';

                const data = {
                    customer_name: document.getElementById('customerName').value.trim(),
                    customer_phone: document.getElementById('customerPhone').value.trim(),
                    device_brand: document.getElementById('deviceBrand').value,
                    device_model: document.getElementById('deviceModel').value.trim(),
                    device_password: document.getElementById('devicePassword').value.trim(),
                    pattern_password: patternSequence.join(','),
                    device_power_on: document.querySelector('input[name="devicePowerOn"]:checked')?.value || '',
                    problem: document.getElementById('problem').value.trim(),
                    estimated_price: parseFloat(document.getElementById('estimatedPrice').value) || 0,
                    deposit: parseFloat(document.getElementById('deposit').value) || 0,
                    estimated_date: document.getElementById('estimatedDate').value || null,
                    items: selectedItems,
                    status: needsOrdering ? 'ç­‰å¾…è®¢è´§' : 'å¾…ç»´ä¿®',
                    order_channel: getOrderChannel(),
                };

                try {
                    const result = await API.orders.create(data);
                    utils.showToast(`å·¥å•åˆ›å»ºæˆåŠŸï¼å·¥å•å·ï¼š${result.order_no}`);

                    // è¯¢é—®æ˜¯å¦æ‰“å°
                    if (confirm(`å·¥å•åˆ›å»ºæˆåŠŸï¼\nå·¥å•å·ï¼š${result.order_no}\n\næ˜¯å¦æ‰“å°å·¥å•ï¼Ÿ`)) {
                        const order = await API.orders.getById(result.id);
                        utils.printOrder(order);
                    }

                    // é‡ç½®è¡¨å•
                    e.target.reset();
                    selectedItems = [];
                    updateSelectedItems();
                    document.getElementById('customerHistory').style.display = 'none';
                    clearPattern();

                    // é‡ç½®ç»´ä¿®é€‰é¡¹æ˜¾ç¤º
                    document.getElementById('repairOptionsContainer').innerHTML = '<span style="color: var(--text-muted); font-size: 0.9rem;">è¯·å…ˆé€‰æ‹©è®¾å¤‡å“ç‰Œå’Œå‹å·</span>';
                    document.getElementById('deviceModelSelect').innerHTML = '<option value="">é€‰æ‹©å‹å·æˆ–æ‰‹åŠ¨è¾“å…¥</option>';

                    // é‡ç½®è®¢è´§æ¸ é“
                    document.getElementById('orderChannelGroup').style.display = 'none';
                    document.querySelectorAll('input[name="orderChannel"]').forEach(r => r.checked = false);
                    document.getElementById('customOrderChannel').value = '';

                } catch (error) {
                    utils.showToast('åˆ›å»ºå¤±è´¥ï¼š' + error.message, 'error');
                }
            });

            // åˆ‡æ¢è®¢è´§æ¸ é“æ˜¾ç¤º
            function toggleOrderChannel() {
                const needsOrdering = document.querySelector('input[name="needsOrdering"]:checked')?.value === 'æ˜¯';
                const channelGroup = document.getElementById('orderChannelGroup');
                channelGroup.style.display = needsOrdering ? 'block' : 'none';

                // å¦‚æœä¸éœ€è¦è®¢è´§ï¼Œæ¸…é™¤è®¢è´§æ¸ é“é€‰æ‹©
                if (!needsOrdering) {
                    document.querySelectorAll('input[name="orderChannel"]').forEach(r => r.checked = false);
                    document.getElementById('customOrderChannel').value = '';
                    document.getElementById('customOrderChannel').style.display = 'none';
                }
            }

            // åˆ‡æ¢è‡ªå®šä¹‰æ¸ é“è¾“å…¥æ¡†
            function toggleCustomChannel() {
                const selected = document.querySelector('input[name="orderChannel"]:checked')?.value;
                const customInput = document.getElementById('customOrderChannel');
                customInput.style.display = selected === 'å…¶å®ƒ' ? 'block' : 'none';
                if (selected !== 'å…¶å®ƒ') {
                    customInput.value = '';
                }
            }

            // è·å–è®¢è´§æ¸ é“
            function getOrderChannel() {
                const needsOrdering = document.querySelector('input[name="needsOrdering"]:checked')?.value === 'æ˜¯';
                if (!needsOrdering) return '';

                const selected = document.querySelector('input[name="orderChannel"]:checked')?.value || '';
                if (selected === 'å…¶å®ƒ') {
                    return document.getElementById('customOrderChannel').value.trim() || 'å…¶å®ƒ';
                }
                return selected;
            }

            // é¡µé¢åˆå§‹åŒ–
            loadDeviceBrands();

            // è®¾ç½®é»˜è®¤é¢„è®¡å®Œæˆæ—¥æœŸä¸ºæ˜å¤©
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('estimatedDate').value = tomorrow.toISOString().split('T')[0];

            // =============== ä¹å®«æ ¼å›¾æ¡ˆå¯†ç é€»è¾‘ ===============
            const patternLock = document.getElementById('patternLock');
            const patternSvg = document.getElementById('patternSvg');
            const patternDots = document.querySelectorAll('.pattern-dot');
            const patternResult = document.getElementById('patternResult');

            // è·å–ç‚¹çš„ä¸­å¿ƒåæ ‡
            function getDotCenter(dot) {
                const rect = dot.getBoundingClientRect();
                const lockRect = patternLock.getBoundingClientRect();
                return {
                    x: rect.left - lockRect.left + rect.width / 2,
                    y: rect.top - lockRect.top + rect.height / 2
                };
            }

            // ç»˜åˆ¶è¿çº¿
            function drawLines() {
                patternSvg.innerHTML = '';
                for (let i = 0; i < patternSequence.length - 1; i++) {
                    const dot1 = document.querySelector(`.pattern-dot[data-index="${patternSequence[i]}"]`);
                    const dot2 = document.querySelector(`.pattern-dot[data-index="${patternSequence[i + 1]}"]`);
                    const p1 = getDotCenter(dot1);
                    const p2 = getDotCenter(dot2);

                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', p1.x);
                    line.setAttribute('y1', p1.y);
                    line.setAttribute('x2', p2.x);
                    line.setAttribute('y2', p2.y);
                    patternSvg.appendChild(line);
                }
            }

            // æ›´æ–°æ˜¾ç¤ºç»“æœ
            function updatePatternResult() {
                if (patternSequence.length === 0) {
                    patternResult.textContent = 'æœªè®¾ç½®';
                    patternResult.classList.remove('has-value');
                } else {
                    patternResult.textContent = patternSequence.map(i => i + 1).join(' â†’ ');
                    patternResult.classList.add('has-value');
                }
            }

            // æ·»åŠ ç‚¹åˆ°åºåˆ—
            function addDotToSequence(index) {
                if (!patternSequence.includes(index)) {
                    patternSequence.push(index);
                    const dot = document.querySelector(`.pattern-dot[data-index="${index}"]`);
                    dot.classList.add('active');
                    drawLines();
                    updatePatternResult();
                }
            }

            // æ¸…é™¤å›¾æ¡ˆ
            function clearPattern() {
                patternSequence = [];
                patternDots.forEach(dot => dot.classList.remove('active'));
                patternSvg.innerHTML = '';
                updatePatternResult();
            }

            // ç‚¹å‡»äº‹ä»¶
            patternDots.forEach(dot => {
                dot.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    isDrawing = true;
                    addDotToSequence(parseInt(dot.dataset.index));
                });

                dot.addEventListener('mouseenter', () => {
                    if (isDrawing) {
                        addDotToSequence(parseInt(dot.dataset.index));
                    }
                });

                // è§¦æ‘¸äº‹ä»¶
                dot.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    isDrawing = true;
                    addDotToSequence(parseInt(dot.dataset.index));
                });
            });

            // è§¦æ‘¸ç§»åŠ¨
            patternLock.addEventListener('touchmove', (e) => {
                if (!isDrawing) return;
                const touch = e.touches[0];
                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                if (element && element.classList.contains('pattern-dot')) {
                    addDotToSequence(parseInt(element.dataset.index));
                }
            });

            // ç»“æŸç»˜åˆ¶
            document.addEventListener('mouseup', () => {
                isDrawing = false;
            });

            document.addEventListener('touchend', () => {
                isDrawing = false;
            });
        </script>
</body>

</html>