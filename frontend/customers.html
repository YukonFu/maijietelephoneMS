<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢æˆ·ç®¡ç† - è¿ˆæ·æ‰‹æœºå†…éƒ¨æµç¨‹ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">
            <span class="logo">ğŸ“±</span>
            <h1>æ‰‹æœºç»´ä¿®ç®¡ç†</h1>
        </a>
        <ul class="navbar-menu">
            <li><a href="index.html">ğŸ  é¦–é¡µ</a></li>
            <li><a href="register.html">ğŸ“ ç™»è®°</a></li>
            <li><a href="front-desk.html">ğŸ“º å‰å°çœ‹æ¿</a></li>
            <li><a href="repair.html">ğŸ”§ ç»´ä¿®çœ‹æ¿</a></li>
            <li><a href="customers.html" class="active">ğŸ‘¥ å®¢æˆ·</a></li>
            <li><a href="pricing.html">ğŸ’° ä»·æ ¼ç®¡ç†</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h2>ğŸ‘¥ å®¢æˆ·ç®¡ç†</h2>
                <p>æŸ¥çœ‹å®¢æˆ·ä¿¡æ¯å’Œç»´ä¿®å†å²</p>
            </div>
            <div class="search-box">
                <span>ğŸ”</span>
                <input type="text" id="searchInput" placeholder="æœç´¢å§“åæˆ–æ‰‹æœºå·...">
            </div>
        </div>

        <div class="card">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>å§“å</th>
                            <th>æ‰‹æœºå·</th>
                            <th>ç»´ä¿®æ¬¡æ•°</th>
                            <th>æ³¨å†Œæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="customersBody">
                        <tr>
                            <td colspan="5" class="empty-state">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- å®¢æˆ·è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="customerModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3>å®¢æˆ·è¯¦æƒ…</h3>
                <button class="modal-close" onclick="closeModal('customerModal')">&times;</button>
            </div>
            <div id="customerModalContent"></div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('customerModal')">å…³é—­</button>
                <button class="btn btn-primary" id="editCustomerBtn">âœï¸ ç¼–è¾‘å®¢æˆ·</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘å®¢æˆ·æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="editCustomerModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3>ç¼–è¾‘å®¢æˆ·</h3>
                <button class="modal-close" onclick="closeModal('editCustomerModal')">&times;</button>
            </div>
            <form id="editCustomerForm">
                <input type="hidden" id="editCustomerId">
                <div class="form-group">
                    <label class="form-label">å§“å</label>
                    <input type="text" class="form-control" id="editCustomerName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ç”µè¯</label>
                    <input type="tel" class="form-control" id="editCustomerPhone" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-ghost" onclick="closeModal('editCustomerModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>


    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script>
        // åŠ è½½å®¢æˆ·åˆ—è¡¨
        async function loadCustomers(search = '') {
            try {
                const params = search ? { search } : {};
                const customers = await API.customers.getAll(params);
                const tbody = document.getElementById('customersBody');

                if (customers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">æš‚æ— å®¢æˆ·æ•°æ®</td></tr>';
                    return;
                }

                tbody.innerHTML = customers.map(customer => `
                    <tr>
                        <td><strong>${customer.name}</strong></td>
                        <td>${customer.phone}</td>
                        <td>${customer.order_count || 0}</td>
                        <td>${utils.formatDate(customer.created_at)}</td>
                        <td class="actions">
                            <button class="btn btn-sm btn-ghost" onclick="showCustomerDetail(${customer.id})">
                                ğŸ‘ï¸ æŸ¥çœ‹
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½å®¢æˆ·å¤±è´¥:', error);
                document.getElementById('customersBody').innerHTML =
                    '<tr><td colspan="5" class="empty-state">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // æ˜¾ç¤ºå®¢æˆ·è¯¦æƒ…
        async function showCustomerDetail(id) {
            try {
                const customer = await API.customers.getById(id);
                currentCustomer = customer;
                const content = document.getElementById('customerModalContent');

                content.innerHTML = `
                    <div style="display: grid; gap: 1.5rem;">
                        <div class="card" style="margin: 0; padding: 1.5rem; background: var(--gradient-primary);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: 600;">${customer.name}</div>
                                    <div style="opacity: 0.8; margin-top: 0.25rem;">ğŸ“ ${customer.phone}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.9rem; opacity: 0.8;">ç´¯è®¡æ¶ˆè´¹</div>
                                    <div style="font-size: 1.5rem; font-weight: 600;">â‚¬${customer.total_spent.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4>ğŸ“‹ ç»´ä¿®å†å² (${customer.total_orders}æ¬¡)</h4>
                            </div>
                            
                            ${customer.orders.length === 0 ?
                        '<div class="empty-state">æš‚æ— ç»´ä¿®è®°å½•</div>' :
                        `<div style="max-height: 400px; overflow-y: auto;">
                                    ${customer.orders.map(order => `
                                        <div class="card" style="margin: 0 0 1rem 0; padding: 1rem;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                                <span style="font-weight: 600; color: var(--accent-purple);">${order.order_no}</span>
                                                <span class="status-badge ${order.status}">${order.status}</span>
                                            </div>
                                            <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                                ${order.device_brand} ${order.device_model}
                                            </div>
                                            <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">
                                                ${order.problem.substring(0, 50)}${order.problem.length > 50 ? '...' : ''}
                                            </div>
                                            <div style="display: flex; justify-content: space-between; margin-top: 0.75rem; font-size: 0.85rem;">
                                                <span style="color: var(--text-muted);">${utils.formatDate(order.created_at)}</span>
                                                <span style="color: var(--accent-green);">${utils.formatPrice(order.final_price || order.estimated_price)}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>`
                    }
                        </div>
                    </div>
                `;

                openModal('customerModal');
            } catch (error) {
                utils.showToast('åŠ è½½è¯¦æƒ…å¤±è´¥', 'error');
            }
        }

        // æœç´¢
        let searchTimeout;
        let currentCustomer = null;

        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadCustomers(e.target.value.trim());
            }, 300);
        });

        // ç¼–è¾‘å®¢æˆ·æŒ‰é’®
        document.getElementById('editCustomerBtn').addEventListener('click', () => {
            if (!currentCustomer) return;
            document.getElementById('editCustomerId').value = currentCustomer.id;
            document.getElementById('editCustomerName').value = currentCustomer.name;
            document.getElementById('editCustomerPhone').value = currentCustomer.phone;
            closeModal('customerModal');
            openModal('editCustomerModal');
        });

        // ä¿å­˜å®¢æˆ·ç¼–è¾‘
        document.getElementById('editCustomerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editCustomerId').value;
            const data = {
                name: document.getElementById('editCustomerName').value.trim(),
                phone: document.getElementById('editCustomerPhone').value.trim()
            };

            try {
                await API.customers.update(id, data);
                utils.showToast('å®¢æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ');
                closeModal('editCustomerModal');
                loadCustomers();
            } catch (error) {
                utils.showToast('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            }
        });

        // åˆå§‹åŒ–
        loadCustomers();
    </script>
</body>

</html>