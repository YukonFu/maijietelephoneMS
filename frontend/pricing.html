<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»·æ ¼ç®¡ç† - è¿ˆæ·æ‰‹æœºå†…éƒ¨æµç¨‹ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">
            <span class="logo">ğŸ“±</span>
            <h1>æ‰‹æœºç»´ä¿®ç®¡ç†</h1>
        </a>
        <ul class="navbar-menu">
            <li><a href="index.html">ğŸ  é¦–é¡µ</a></li>
            <li><a href="register.html">ğŸ“ ç™»è®°</a></li>
            <li><a href="front-desk.html">ğŸ“º å‰å°çœ‹æ¿</a></li>
            <li><a href="repair.html">ğŸ”§ ç»´ä¿®çœ‹æ¿</a></li>
            <li><a href="customers.html">ğŸ‘¥ å®¢æˆ·</a></li>
            <li><a href="pricing.html" class="active">ğŸ’° ä»·æ ¼ç®¡ç†</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h2>ğŸ’° ä»·æ ¼ç®¡ç†</h2>
                <p>ç®¡ç†ç»´ä¿®é¡¹ç›®å’Œé…ä»¶ä»·æ ¼</p>
            </div>
            <button class="btn btn-primary" onclick="showAddModal()">
                â• æ‰¹é‡æ·»åŠ 
            </button>
        </div>

        <!-- ç­›é€‰æ  -->
        <div class="card" style="margin-bottom: 1.5rem; padding: 1rem;">
            <div class="form-row" style="margin-bottom: 0;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" style="font-size: 0.85rem;">å“ç‰Œç­›é€‰</label>
                    <select class="form-control" id="filterBrand" onchange="onBrandChange()">
                        <option value="">å…¨éƒ¨å“ç‰Œ</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" style="font-size: 0.85rem;">å‹å·ç­›é€‰</label>
                    <select class="form-control" id="filterModel" onchange="applyFilter()">
                        <option value="">å…¨éƒ¨å‹å·</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" style="font-size: 0.85rem;">ç»´ä¿®ç±»å‹ç­›é€‰</label>
                    <select class="form-control" id="filterCategory" onchange="applyFilter()">
                        <option value="">å…¨éƒ¨ç±»å‹</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0; display: flex; align-items: flex-end;">
                    <button class="btn btn-ghost" onclick="clearFilters()">ğŸ”„ æ¸…é™¤ç­›é€‰</button>
                </div>
            </div>
        </div>

        <div id="pricingContainer"></div>
    </div>

    <!-- æ‰¹é‡æ·»åŠ æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="pricingModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="modalTitle">æ‰¹é‡æ·»åŠ ä»·æ ¼é¡¹ç›®</h3>
                <button class="modal-close" onclick="closeModal('pricingModal')">&times;</button>
            </div>
            <form id="pricingForm">
                <input type="hidden" id="pricingId">

                <!-- è®¾å¤‡é€‰æ‹© -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">å“ç‰Œ *</label>
                        <select class="form-control" id="pricingBrandSelect" onchange="onBrandSelectChange()">
                            <option value="">é€‰æ‹©å“ç‰Œ</option>
                        </select>
                        <input type="text" class="form-control" id="pricingBrand" placeholder="æˆ–æ‰‹åŠ¨è¾“å…¥å“ç‰Œ"
                            style="margin-top: 0.5rem;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å‹å· *</label>
                        <select class="form-control" id="pricingModelSelect" onchange="onModelSelectChange()">
                            <option value="">é€‰æ‹©å‹å·</option>
                        </select>
                        <input type="text" class="form-control" id="pricingModel" placeholder="æˆ–æ‰‹åŠ¨è¾“å…¥å‹å·"
                            style="margin-top: 0.5rem;">
                    </div>
                </div>

                <!-- ç»´ä¿®é¡¹ç›®åˆ—è¡¨ -->
                <div class="form-group">
                    <label class="form-label">ç»´ä¿®é¡¹ç›® <span
                            style="font-size: 0.85rem; color: var(--text-muted);">(å¯æ·»åŠ å¤šä¸ª)</span></label>
                    <div id="repairItemsList">
                        <!-- åŠ¨æ€æ·»åŠ  -->
                    </div>
                    <button type="button" class="btn btn-ghost" onclick="addRepairItemRow()"
                        style="margin-top: 0.5rem;">
                        â• æ·»åŠ æ›´å¤šé¡¹ç›®
                    </button>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-ghost" onclick="closeModal('pricingModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜å…¨éƒ¨</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘å•é¡¹æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="editModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3>ç¼–è¾‘ä»·æ ¼é¡¹ç›®</h3>
                <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">å“ç‰Œ</label>
                        <input type="text" class="form-control" id="editBrand" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å‹å·</label>
                        <input type="text" class="form-control" id="editModel" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ç»´ä¿®ç±»å‹</label>
                    <input type="text" class="form-control" id="editCategory" required>
                </div>
                <div class="form-group">
                    <label class="form-label">æ„å¤§åˆ©è¯­åç§°</label>
                    <input type="text" class="form-control" id="editNameIt">
                </div>
                <div class="form-group">
                    <label class="form-label">ä»·æ ¼ (â‚¬)</label>
                    <input type="number" class="form-control" id="editPrice" required step="0.01" min="0">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-ghost" onclick="closeModal('editModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script>
        let allPricing = [];
        let filteredPricing = [];
        let allBrands = [];
        let allModels = [];
        let allCategories = [];

        // åŠ è½½ä»·æ ¼åˆ—è¡¨
        async function loadPricing() {
            try {
                allPricing = await API.pricing.getAll();

                // æå–å”¯ä¸€çš„å“ç‰Œã€å‹å·ã€åˆ†ç±»
                allBrands = [...new Set(allPricing.map(p => p.brand).filter(b => b))];
                allModels = [...new Set(allPricing.map(p => p.model).filter(m => m))];
                allCategories = [...new Set(allPricing.map(p => p.category).filter(c => c))];

                updateFilterOptions();
                onFilterChange();
            } catch (error) {
                console.error('åŠ è½½ä»·æ ¼å¤±è´¥:', error);
                utils.showToast('åŠ è½½å¤±è´¥', 'error');
            }
        }

        // æ›´æ–°ç­›é€‰é€‰é¡¹
        function updateFilterOptions() {
            const brandSelect = document.getElementById('filterBrand');
            const modelSelect = document.getElementById('filterModel');
            const categorySelect = document.getElementById('filterCategory');

            brandSelect.innerHTML = '<option value="">å…¨éƒ¨å“ç‰Œ</option>' +
                allBrands.map(b => `<option value="${b}">${b}</option>`).join('');

            modelSelect.innerHTML = '<option value="">å…¨éƒ¨å‹å·</option>' +
                allModels.map(m => `<option value="${m}">${m}</option>`).join('');

            categorySelect.innerHTML = '<option value="">å…¨éƒ¨ç±»å‹</option>' +
                allCategories.map(c => `<option value="${c}">${c}</option>`).join('');
        }




        // å“ç‰Œå˜åŒ–æ—¶æ›´æ–°å‹å·ä¸‹æ‹‰æ¡†
        function onBrandChange() {
            const brand = document.getElementById('filterBrand').value;
            const modelSelect = document.getElementById('filterModel');

            if (brand) {
                const brandModels = [...new Set(allPricing.filter(p => p.brand === brand).map(p => p.model).filter(m => m))];
                modelSelect.innerHTML = '<option value="">å…¨éƒ¨å‹å·</option>' +
                    brandModels.map(m => `<option value="${m}">${m}</option>`).join('');
            } else {
                modelSelect.innerHTML = '<option value="">å…¨éƒ¨å‹å·</option>' +
                    allModels.map(m => `<option value="${m}">${m}</option>`).join('');
            }

            applyFilter();
        }

        // åº”ç”¨ç­›é€‰
        function applyFilter() {
            const brand = document.getElementById('filterBrand').value;
            const model = document.getElementById('filterModel').value;
            const category = document.getElementById('filterCategory').value;

            filteredPricing = allPricing.filter(item => {
                if (brand && item.brand !== brand) return false;
                if (model && item.model !== model) return false;
                if (category && item.category !== category) return false;
                return true;
            });

            renderPricing();
        }

        // å…¼å®¹æ—§ä»£ç 
        function onFilterChange() {
            applyFilter();
        }

        // æ¸…é™¤ç­›é€‰
        function clearFilters() {
            document.getElementById('filterBrand').value = '';
            document.getElementById('filterModel').value = '';
            document.getElementById('filterCategory').value = '';
            // é‡ç½®å‹å·ä¸‹æ‹‰æ¡†æ˜¾ç¤ºæ‰€æœ‰å‹å·
            document.getElementById('filterModel').innerHTML = '<option value="">å…¨éƒ¨å‹å·</option>' +
                allModels.map(m => `<option value="${m}">${m}</option>`).join('');
            applyFilter();
        }

        // æ¸²æŸ“ä»·æ ¼åˆ—è¡¨
        function renderPricing() {
            const container = document.getElementById('pricingContainer');

            if (filteredPricing.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ’°</div>
                            <p>æš‚æ— ä»·æ ¼é¡¹ç›®</p>
                            <button class="btn btn-primary" style="margin-top: 1rem;" onclick="showAddModal()">
                                â• æ·»åŠ ç¬¬ä¸€ä¸ªé¡¹ç›®
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            // æŒ‰å“ç‰Œåˆ†ç»„
            const grouped = filteredPricing.reduce((acc, item) => {
                const brand = item.brand || 'æœªåˆ†ç±»';
                if (!acc[brand]) acc[brand] = [];
                acc[brand].push(item);
                return acc;
            }, {});

            container.innerHTML = Object.entries(grouped).map(([brand, items]) => `
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“± ${brand}</h3>
                        <span class="tag">${items.length} é¡¹</span>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>å‹å·</th>
                                    <th>ç»´ä¿®ç±»å‹</th>
                                    <th>æ„å¤§åˆ©è¯­</th>
                                    <th>ä»·æ ¼</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(item => `
                                    <tr>
                                        <td>${item.model || '-'}</td>
                                        <td>${item.category}</td>
                                        <td style="color: var(--text-muted); font-size: 0.9rem;">${item.name_it || '-'}</td>
                                        <td><span style="color: var(--accent-green); font-weight: 600;">â‚¬${item.price.toFixed(2)}</span></td>
                                        <td class="actions">
                                            <button class="btn btn-sm btn-ghost" onclick="showEditModal(${item.id})">
                                                âœï¸ ç¼–è¾‘
                                            </button>
                                            <button class="btn btn-sm btn-ghost" onclick="deletePricing(${item.id})" style="color: var(--accent-orange);">
                                                ğŸ—‘ï¸ åˆ é™¤
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºæ·»åŠ æ¨¡æ€æ¡†
        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'æ‰¹é‡æ·»åŠ ä»·æ ¼é¡¹ç›®';
            document.getElementById('pricingId').value = '';
            document.getElementById('pricingBrand').value = '';
            document.getElementById('pricingModel').value = '';

            // å¡«å……å“ç‰Œä¸‹æ‹‰
            const brandSelect = document.getElementById('pricingBrandSelect');
            brandSelect.innerHTML = '<option value="">é€‰æ‹©å·²æœ‰å“ç‰Œ</option>' +
                allBrands.map(b => `<option value="${b}">${b}</option>`).join('') +
                '<option value="__new__">+ æ·»åŠ æ–°å“ç‰Œ</option>';

            document.getElementById('pricingModelSelect').innerHTML = '<option value="">é€‰æ‹©å·²æœ‰å‹å·</option>';

            // æ¸…ç©ºå¹¶æ·»åŠ ä¸€è¡Œç»´ä¿®é¡¹ç›®
            document.getElementById('repairItemsList').innerHTML = '';
            addRepairItemRow();

            openModal('pricingModal');
        }

        // æ·»åŠ ç»´ä¿®é¡¹ç›®è¡Œ
        function addRepairItemRow() {
            const container = document.getElementById('repairItemsList');
            const rowId = Date.now();

            const row = document.createElement('div');
            row.className = 'form-row repair-item-row';
            row.id = `repair-row-${rowId}`;
            row.style.cssText = 'background: var(--bg-glass); padding: 0.75rem; border-radius: var(--radius-md); margin-bottom: 0.5rem;';
            row.innerHTML = `
                <div class="form-group" style="flex: 2;">
                    <input type="text" class="form-control repair-category" placeholder="ç»´ä¿®ç±»å‹ (å¦‚ï¼šå±å¹•ç»´ä¿®)" required>
                </div>
                <div class="form-group" style="flex: 2;">
                    <input type="text" class="form-control repair-name-it" placeholder="æ„å¤§åˆ©è¯­ (å¯é€‰)">
                </div>
                <div class="form-group" style="flex: 1;">
                    <input type="number" class="form-control repair-price" placeholder="â‚¬ä»·æ ¼" step="0.01" min="0" required>
                </div>
                <div class="form-group" style="flex: 0; margin-bottom: 0;">
                    <button type="button" class="btn btn-ghost" onclick="removeRepairItemRow('${rowId}')" style="color: var(--accent-orange); padding: 0.5rem;">
                        âœ•
                    </button>
                </div>
            `;
            container.appendChild(row);
        }

        // åˆ é™¤ç»´ä¿®é¡¹ç›®è¡Œ
        function removeRepairItemRow(rowId) {
            const row = document.getElementById(`repair-row-${rowId}`);
            if (row && document.querySelectorAll('.repair-item-row').length > 1) {
                row.remove();
            } else {
                utils.showToast('è‡³å°‘ä¿ç•™ä¸€ä¸ªé¡¹ç›®', 'error');
            }
        }

        // å“ç‰Œä¸‹æ‹‰å˜åŒ–
        function onBrandSelectChange() {
            const select = document.getElementById('pricingBrandSelect');
            const input = document.getElementById('pricingBrand');
            const modelSelect = document.getElementById('pricingModelSelect');

            if (select.value === '__new__') {
                input.focus();
                input.value = '';
            } else if (select.value) {
                input.value = select.value;

                // åŠ è½½è¯¥å“ç‰Œçš„å‹å·
                const brandModels = [...new Set(allPricing.filter(p => p.brand === select.value).map(p => p.model).filter(m => m))];
                modelSelect.innerHTML = '<option value="">é€‰æ‹©å·²æœ‰å‹å·</option>' +
                    brandModels.map(m => `<option value="${m}">${m}</option>`).join('') +
                    '<option value="__new__">+ æ·»åŠ æ–°å‹å·</option>';
            }
        }

        // å‹å·ä¸‹æ‹‰å˜åŒ–
        function onModelSelectChange() {
            const select = document.getElementById('pricingModelSelect');
            const input = document.getElementById('pricingModel');

            if (select.value === '__new__') {
                input.focus();
                input.value = '';
            } else if (select.value) {
                input.value = select.value;
            }
        }

        // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
        function showEditModal(id) {
            const item = allPricing.find(p => p.id === id);
            if (!item) return;

            document.getElementById('editId').value = item.id;
            document.getElementById('editBrand').value = item.brand || '';
            document.getElementById('editModel').value = item.model || '';
            document.getElementById('editCategory').value = item.category;
            document.getElementById('editNameIt').value = item.name_it || '';
            document.getElementById('editPrice').value = item.price;

            openModal('editModal');
        }

        // æ‰¹é‡æ·»åŠ è¡¨å•æäº¤
        document.getElementById('pricingForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const brand = document.getElementById('pricingBrand').value.trim();
            const model = document.getElementById('pricingModel').value.trim();

            if (!brand || !model) {
                utils.showToast('è¯·å¡«å†™å“ç‰Œå’Œå‹å·', 'error');
                return;
            }

            const rows = document.querySelectorAll('.repair-item-row');
            const items = [];

            rows.forEach(row => {
                const category = row.querySelector('.repair-category').value.trim();
                const nameIt = row.querySelector('.repair-name-it').value.trim();
                const price = parseFloat(row.querySelector('.repair-price').value) || 0;

                if (category && price > 0) {
                    items.push({
                        brand,
                        model,
                        category,
                        name: `${model} ${category}`,
                        name_it: nameIt,
                        price
                    });
                }
            });

            if (items.length === 0) {
                utils.showToast('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªç»´ä¿®é¡¹ç›®', 'error');
                return;
            }

            try {
                for (const item of items) {
                    await API.pricing.create(item);
                }
                utils.showToast(`æˆåŠŸæ·»åŠ  ${items.length} ä¸ªé¡¹ç›®`);
                closeModal('pricingModal');
                loadPricing();
            } catch (error) {
                utils.showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        });

        // ç¼–è¾‘è¡¨å•æäº¤
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('editId').value;
            const data = {
                brand: document.getElementById('editBrand').value.trim(),
                model: document.getElementById('editModel').value.trim(),
                category: document.getElementById('editCategory').value.trim(),
                name: `${document.getElementById('editModel').value.trim()} ${document.getElementById('editCategory').value.trim()}`,
                name_it: document.getElementById('editNameIt').value.trim(),
                price: parseFloat(document.getElementById('editPrice').value)
            };

            try {
                await API.pricing.update(id, data);
                utils.showToast('æ›´æ–°æˆåŠŸ');
                closeModal('editModal');
                loadPricing();
            } catch (error) {
                utils.showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        });

        // åˆ é™¤ä»·æ ¼é¡¹ç›®
        async function deletePricing(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä»·æ ¼é¡¹ç›®å—ï¼Ÿ')) return;

            try {
                await API.pricing.delete(id);
                utils.showToast('åˆ é™¤æˆåŠŸ');
                loadPricing();
            } catch (error) {
                utils.showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆå§‹åŒ–
        loadPricing();
    </script>
</body>

</html>