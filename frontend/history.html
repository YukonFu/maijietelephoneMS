<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»´ä¿®è®°å½•æŸ¥è¯¢ - è¿ˆæ·æ‰‹æœºå†…éƒ¨æµç¨‹ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">
            <span class="logo">ğŸ“±</span>
            <h1>æ‰‹æœºç»´ä¿®ç®¡ç†</h1>
        </a>
        <ul class="navbar-menu">
            <li><a href="index.html">ğŸ  é¦–é¡µ</a></li>
            <li><a href="register.html">ğŸ“ ç™»è®°</a></li>
            <li><a href="front-desk.html">ğŸ“º å‰å°çœ‹æ¿</a></li>
            <li><a href="repair.html">ğŸ”§ ç»´ä¿®çœ‹æ¿</a></li>
            <li><a href="customers.html">ğŸ‘¥ å®¢æˆ·</a></li>
            <li><a href="pricing.html">ğŸ’° ä»·æ ¼ç®¡ç†</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-header">
            <h2>ğŸ“‹ ç»´ä¿®è®°å½•æŸ¥è¯¢</h2>
            <p>æŸ¥è¯¢å’Œç­›é€‰æ‰€æœ‰å†å²ç»´ä¿®å·¥å•</p>
        </div>

        <!-- ç­›é€‰æ  -->
        <div class="card" style="margin-bottom: 1.5rem; padding: 1rem;">
            <div class="form-row" style="margin-bottom: 0.5rem;">
                <div class="form-group" style="margin-bottom: 0; flex: 2;">
                    <label class="form-label" style="font-size: 0.85rem;">ğŸ” å…³é”®è¯æœç´¢</label>
                    <input type="text" class="form-control" id="searchKeyword" placeholder="å·¥å•å·ã€å®¢æˆ·å§“åã€ç”µè¯æˆ–è®¾å¤‡å‹å·...">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" style="font-size: 0.85rem;">å·¥å•çŠ¶æ€</label>
                    <select class="form-control" id="filterStatus">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="ç­‰å¾…è®¢è´§">ç­‰å¾…è®¢è´§</option>
                        <option value="å¾…ç»´ä¿®">å¾…ç»´ä¿®</option>
                        <option value="ç»´ä¿®ä¸­">ç»´ä¿®ä¸­</option>
                        <option value="å¾…å–æœº">å¾…å–æœº</option>
                        <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" style="font-size: 0.85rem;">è®¾å¤‡å“ç‰Œ</label>
                    <select class="form-control" id="filterBrand">
                        <option value="">å…¨éƒ¨å“ç‰Œ</option>
                    </select>
                </div>
            </div>
            <div class="form-row" style="margin-bottom: 0;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" style="font-size: 0.85rem;">å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" class="form-control" id="filterDateFrom">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" style="font-size: 0.85rem;">ç»“æŸæ—¥æœŸ</label>
                    <input type="date" class="form-control" id="filterDateTo">
                </div>
                <div class="form-group" style="margin-bottom: 0; display: flex; align-items: flex-end; gap: 0.5rem;">
                    <button class="btn btn-primary" onclick="applyFilters()">ğŸ” æŸ¥è¯¢</button>
                    <button class="btn btn-ghost" onclick="clearFilters()">ğŸ”„ æ¸…é™¤</button>
                </div>
            </div>
        </div>

        <!-- ç»“æœç»Ÿè®¡ -->
        <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <span style="color: var(--text-muted);">å…±æ‰¾åˆ° </span>
                <span id="resultCount" style="font-weight: 600; color: var(--accent-purple);">0</span>
                <span style="color: var(--text-muted);"> æ¡è®°å½•</span>
            </div>
            <a href="front-desk.html" class="btn btn-ghost">â† è¿”å›å‰å°çœ‹æ¿</a>
        </div>

        <!-- ç»“æœåˆ—è¡¨ -->
        <div id="resultContainer"></div>
    </div>

    <!-- å·¥å•è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="orderModal">
        <div class="modal">
            <div class="modal-header">
                <h3>å·¥å•è¯¦æƒ…</h3>
                <button class="modal-close" onclick="closeModal('orderModal')">&times;</button>
            </div>
            <div id="orderModalContent"></div>
            <div class="modal-footer">
                <button class="btn btn-ghost" style="color: var(--accent-orange);" onclick="deleteOrder()">ğŸ—‘ï¸
                    åˆ é™¤å·¥å•</button>
                <button class="btn btn-ghost" onclick="closeModal('orderModal')">å…³é—­</button>
                <button class="btn btn-primary" id="printOrderBtn">ğŸ–¨ï¸ æ‰“å°å·¥å•</button>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script>
        let allOrders = [];
        let filteredOrders = [];
        let currentOrder = null;

        // æ ¼å¼åŒ–å›¾æ¡ˆå¯†ç æ˜¾ç¤º
        function formatPatternPassword(pattern) {
            if (!pattern) return '';
            return pattern.split(',').map(i => parseInt(i) + 1).join(' â†’ ');
        }

        // åŠ è½½æ‰€æœ‰å·¥å•
        async function loadAllOrders() {
            try {
                allOrders = await API.orders.getAll();

                // æå–å”¯ä¸€çš„å“ç‰Œ
                const brands = [...new Set(allOrders.map(o => o.device_brand).filter(b => b))];
                const brandSelect = document.getElementById('filterBrand');
                brandSelect.innerHTML = '<option value="">å…¨éƒ¨å“ç‰Œ</option>' +
                    brands.map(b => `<option value="${b}">${b}</option>`).join('');

                applyFilters();
            } catch (error) {
                console.error('åŠ è½½å·¥å•å¤±è´¥:', error);
                utils.showToast('åŠ è½½å¤±è´¥', 'error');
            }
        }

        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            const keyword = document.getElementById('searchKeyword').value.trim().toLowerCase();
            const status = document.getElementById('filterStatus').value;
            const brand = document.getElementById('filterBrand').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;

            filteredOrders = allOrders.filter(order => {
                // å…³é”®è¯æœç´¢
                if (keyword) {
                    const searchFields = [
                        order.order_no,
                        order.customer_name,
                        order.customer_phone,
                        order.device_brand,
                        order.device_model,
                        order.problem
                    ].join(' ').toLowerCase();
                    if (!searchFields.includes(keyword)) return false;
                }

                // çŠ¶æ€ç­›é€‰
                if (status && order.status !== status) return false;

                // å“ç‰Œç­›é€‰
                if (brand && order.device_brand !== brand) return false;

                // æ—¥æœŸç­›é€‰
                if (dateFrom) {
                    const orderDate = new Date(order.created_at);
                    const fromDate = new Date(dateFrom);
                    if (orderDate < fromDate) return false;
                }
                if (dateTo) {
                    const orderDate = new Date(order.created_at);
                    const toDate = new Date(dateTo);
                    toDate.setHours(23, 59, 59, 999);
                    if (orderDate > toDate) return false;
                }

                return true;
            });

            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            filteredOrders.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            renderResults();
        }

        // æ¸…é™¤ç­›é€‰
        function clearFilters() {
            document.getElementById('searchKeyword').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterBrand').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            applyFilters();
        }

        // æ¸²æŸ“ç»“æœ
        function renderResults() {
            const container = document.getElementById('resultContainer');
            document.getElementById('resultCount').textContent = filteredOrders.length;

            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <p>æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å·¥å•</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="card" style="padding: 0; overflow: hidden;">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>å·¥å•å·</th>
                                    <th>å®¢æˆ·</th>
                                    <th>è®¾å¤‡</th>
                                    <th>æ•…éšœæè¿°</th>
                                    <th>çŠ¶æ€</th>
                                    <th>ä»·æ ¼</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredOrders.map(order => `
                                    <tr>
                                        <td><span style="color: var(--accent-purple); font-weight: 600;">${order.order_no}</span></td>
                                        <td>
                                            <div>${order.customer_name || '-'}</div>
                                            <div style="color: var(--text-muted); font-size: 0.85rem;">${order.customer_phone || ''}</div>
                                        </td>
                                        <td>${order.device_brand} ${order.device_model}</td>
                                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${order.problem}">${order.problem}</td>
                                        <td><span class="status-badge ${order.status}">${order.status}</span></td>
                                        <td><span style="color: var(--accent-green);">${utils.formatPrice(order.final_price || order.estimated_price)}</span></td>
                                        <td style="font-size: 0.85rem;">${utils.formatDate(order.created_at)}</td>
                                        <td>
                                            <button class="btn btn-sm btn-ghost" onclick="showOrderDetail(${order.id})">ğŸ“‹ è¯¦æƒ…</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // æ˜¾ç¤ºå·¥å•è¯¦æƒ…
        async function showOrderDetail(id) {
            try {
                currentOrder = await API.orders.getById(id);
                const content = document.getElementById('orderModalContent');

                content.innerHTML = `
                    <div style="display: grid; gap: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: var(--accent-purple);">${currentOrder.order_no}</div>
                                <div style="color: var(--text-muted); font-size: 0.9rem;">åˆ›å»ºäº ${utils.formatDate(currentOrder.created_at)}</div>
                            </div>
                            <span class="status-badge ${currentOrder.status}">${currentOrder.status}</span>
                        </div>

                        <div class="card" style="margin: 0; padding: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">ğŸ‘¤ å®¢æˆ·ä¿¡æ¯</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
                                <div><span style="color: var(--text-muted);">å§“åï¼š</span>${currentOrder.customer_name || '-'}</div>
                                <div><span style="color: var(--text-muted);">ç”µè¯ï¼š</span>${currentOrder.customer_phone || '-'}</div>
                            </div>
                        </div>

                        <div class="card" style="margin: 0; padding: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">ğŸ“± è®¾å¤‡ä¿¡æ¯</div>
                            <div style="font-size: 0.9rem;">
                                <div><span style="color: var(--text-muted);">å“ç‰Œå‹å·ï¼š</span>${currentOrder.device_brand} ${currentOrder.device_model}</div>
                                ${currentOrder.device_password ? `<div style="margin-top: 0.5rem;"><span style="color: var(--text-muted);">ğŸ” è®¾å¤‡å¯†ç ï¼š</span><span style="color: var(--accent-blue); font-family: monospace;">${currentOrder.device_password}</span></div>` : ''}
                                ${currentOrder.pattern_password ? `<div style="margin-top: 0.5rem;"><span style="color: var(--text-muted);">ğŸ“ å›¾æ¡ˆå¯†ç ï¼š</span><span style="color: var(--accent-purple); font-family: monospace;">${formatPatternPassword(currentOrder.pattern_password)}</span></div>` : ''}
                                <div style="margin-top: 0.5rem;"><span style="color: var(--text-muted);">æ•…éšœæè¿°ï¼š</span></div>
                                <div style="padding: 0.75rem; background: var(--bg-glass); border-radius: var(--radius-sm); margin-top: 0.25rem; white-space: pre-line;">
                                    ${currentOrder.problem}
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin: 0; padding: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">ğŸ’° è´¹ç”¨ä¿¡æ¯</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
                                <div><span style="color: var(--text-muted);">é¢„ä¼°ä»·æ ¼ï¼š</span><span style="color: var(--accent-green);">${utils.formatPrice(currentOrder.estimated_price)}</span></div>
                                <div><span style="color: var(--text-muted);">æŠ¼é‡‘ï¼š</span><span style="color: var(--accent-blue);">${utils.formatPrice(currentOrder.deposit || 0)}</span></div>
                                <div><span style="color: var(--text-muted);">å®é™…ä»·æ ¼ï¼š</span><span style="color: var(--accent-green); font-weight: 600;">${utils.formatPrice(currentOrder.final_price)}</span></div>
                                <div><span style="color: var(--text-muted);">é¢„è®¡å®Œæˆï¼š</span>${currentOrder.estimated_date || '-'}</div>
                            </div>
                        </div>

                        ${currentOrder.repair_notes ? `
                        <div class="card" style="margin: 0; padding: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">ğŸ“ ç»´ä¿®å¤‡æ³¨</div>
                            <div style="padding: 0.75rem; background: var(--bg-glass); border-radius: var(--radius-sm); font-size: 0.9rem; white-space: pre-line;">
                                ${currentOrder.repair_notes}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;

                openModal('orderModal');
            } catch (error) {
                utils.showToast('åŠ è½½è¯¦æƒ…å¤±è´¥', 'error');
            }
        }

        // æ‰“å°å·¥å•
        document.getElementById('printOrderBtn').addEventListener('click', () => {
            if (currentOrder) {
                utils.printOrder(currentOrder);
            }
        });

        // å›è½¦æœç´¢
        document.getElementById('searchKeyword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });

        // åˆ é™¤å·¥å•
        async function deleteOrder() {
            if (!currentOrder) return;

            const confirmMsg = `ç¡®å®šè¦åˆ é™¤å·¥å• ${currentOrder.order_no} å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`;
            if (!confirm(confirmMsg)) return;

            try {
                await API.orders.delete(currentOrder.id);
                utils.showToast('å·¥å•å·²åˆ é™¤');
                closeModal('orderModal');
                loadAllOrders();
            } catch (error) {
                utils.showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆå§‹åŒ–
        loadAllOrders();
    </script>
</body>

</html>