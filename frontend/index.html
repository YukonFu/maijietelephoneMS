<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿ˆæ·æ‰‹æœºå†…éƒ¨æµç¨‹ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">
            <span class="logo">ğŸ“±</span>
            <h1>æ‰‹æœºç»´ä¿®ç®¡ç†</h1>
        </a>
        <ul class="navbar-menu">
            <li><a href="index.html" class="active">ğŸ  é¦–é¡µ</a></li>
            <li><a href="register.html">ğŸ“ ç™»è®°</a></li>
            <li><a href="front-desk.html">ğŸ“º å‰å°çœ‹æ¿</a></li>
            <li><a href="repair.html">ğŸ”§ ç»´ä¿®çœ‹æ¿</a></li>
            <li><a href="customers.html">ğŸ‘¥ å®¢æˆ·</a></li>
            <li><a href="pricing.html">ğŸ’° ä»·æ ¼ç®¡ç†</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-header">
            <h2>ğŸ“Š å·¥ä½œå°</h2>
            <p>æ¬¢è¿ä½¿ç”¨æ‰‹æœºç»´ä¿®ç®¡ç†ç³»ç»Ÿ</p>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-icon purple">ğŸ“‹</div>
                <div class="stat-info">
                    <h3 id="totalOrders">-</h3>
                    <p>æ€»å·¥å•æ•°</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon pink">â³</div>
                <div class="stat-info">
                    <h3 id="pendingOrders">-</h3>
                    <p>å¾…ç»´ä¿®</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon blue">ğŸ”§</div>
                <div class="stat-info">
                    <h3 id="inProgressOrders">-</h3>
                    <p>ç»´ä¿®ä¸­</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">âœ…</div>
                <div class="stat-info">
                    <h3 id="waitingPickup">-</h3>
                    <p>å¾…å–æœº</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"
                    style="background: linear-gradient(135deg, rgba(102, 187, 106, 0.2), rgba(76, 175, 80, 0.3));">ğŸ’°
                </div>
                <div class="stat-info">
                    <h3 id="totalRevenue">-</h3>
                    <p>æ€»æ”¶å…¥</p>
                </div>
            </div>
        </div>

        <!-- å¿«æ·æ“ä½œ -->
        <div class="card" style="margin-bottom: 2rem;">
            <div class="card-header">
                <h3 class="card-title">å¿«æ·æ“ä½œ</h3>
            </div>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <a href="register.html" class="btn btn-primary">
                    â• æ–°å»ºå·¥å•
                </a>
                <a href="front-desk.html" class="btn btn-ghost">
                    ğŸ“º æŸ¥çœ‹å‰å°çœ‹æ¿
                </a>
                <a href="repair.html" class="btn btn-ghost">
                    ğŸ”§ è¿›å…¥ç»´ä¿®çœ‹æ¿
                </a>
            </div>
        </div>

        <!-- ç»Ÿè®¡å›¾è¡¨ -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“ˆ æœ¬å‘¨å·¥å•è¶‹åŠ¿</h3>
                </div>
                <div style="height: 250px;">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“Š å·¥å•çŠ¶æ€åˆ†å¸ƒ</h3>
                </div>
                <div style="height: 250px; display: flex; align-items: center; justify-content: center;">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- æœ€è¿‘å·¥å• -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">æœ€è¿‘å·¥å•</h3>
                <a href="front-desk.html" class="btn btn-sm btn-ghost">æŸ¥çœ‹å…¨éƒ¨</a>
            </div>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>å·¥å•å·</th>
                            <th>å®¢æˆ·</th>
                            <th>è®¾å¤‡</th>
                            <th>é—®é¢˜</th>
                            <th>çŠ¶æ€</th>
                            <th>æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="recentOrdersBody">
                        <tr>
                            <td colspan="6" class="empty-state">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script>
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const stats = await API.stats.get();
                document.getElementById('totalOrders').textContent = stats.totalOrders;
                document.getElementById('pendingOrders').textContent = stats.pendingOrders;
                document.getElementById('inProgressOrders').textContent = stats.inProgressOrders;
                document.getElementById('waitingPickup').textContent = stats.waitingPickup;
                document.getElementById('totalRevenue').textContent = 'â‚¬' + (stats.totalRevenue || 0).toFixed(2);
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // åŠ è½½æœ€è¿‘å·¥å•
        async function loadRecentOrders() {
            try {
                const orders = await API.orders.getAll();
                const tbody = document.getElementById('recentOrdersBody');

                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">æš‚æ— å·¥å•</td></tr>';
                    return;
                }

                tbody.innerHTML = orders.slice(0, 10).map(order => `
                    <tr>
                        <td><strong>${order.order_no}</strong></td>
                        <td>${order.customer_name || '-'}</td>
                        <td>${order.device_brand} ${order.device_model}</td>
                        <td>${order.problem.substring(0, 20)}${order.problem.length > 20 ? '...' : ''}</td>
                        <td><span class="status-badge ${order.status}">${order.status}</span></td>
                        <td>${utils.formatDate(order.created_at)}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½å·¥å•å¤±è´¥:', error);
                document.getElementById('recentOrdersBody').innerHTML =
                    '<tr><td colspan="6" class="empty-state">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</td></tr>';
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        loadStats();
        loadRecentOrders();
        loadCharts();

        // åŠ è½½å›¾è¡¨
        async function loadCharts() {
            try {
                const orders = await API.orders.getAll();
                renderWeeklyChart(orders);
                renderStatusChart(orders);
            } catch (error) {
                console.error('åŠ è½½å›¾è¡¨æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“æœ¬å‘¨å·¥å•è¶‹åŠ¿å›¾
        function renderWeeklyChart(orders) {
            const ctx = document.getElementById('weeklyChart').getContext('2d');

            // è®¡ç®—æœ€è¿‘7å¤©æ¯å¤©çš„å·¥å•æ•°
            const days = [];
            const counts = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayName = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()];
                days.push(dayName);

                const count = orders.filter(o => o.created_at.startsWith(dateStr)).length;
                counts.push(count);
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'å·¥å•æ•°',
                        data: counts,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
        }

        // æ¸²æŸ“å·¥å•çŠ¶æ€åˆ†å¸ƒå›¾
        function renderStatusChart(orders) {
            const ctx = document.getElementById('statusChart').getContext('2d');

            const statusCounts = {
                'ç­‰å¾…è®¢è´§': 0,
                'å¾…ç»´ä¿®': 0,
                'ç»´ä¿®ä¸­': 0,
                'å¾…å–æœº': 0,
                'å·²å®Œæˆ': 0
            };

            orders.forEach(o => {
                if (statusCounts.hasOwnProperty(o.status)) {
                    statusCounts[o.status]++;
                }
            });

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            'rgba(245, 87, 108, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(33, 150, 243, 0.8)',
                            'rgba(156, 39, 176, 0.8)',
                            'rgba(76, 175, 80, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: 'rgba(255,255,255,0.8)', boxWidth: 12, padding: 8 }
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>