<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç®¡ç† - è¿ˆæ·æ‰‹æœºå†…éƒ¨æµç¨‹ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">
            <span class="logo">ğŸ“±</span>
            <h1>æ‰‹æœºç»´ä¿®ç®¡ç†</h1>
        </a>
        <ul class="navbar-menu">
            <li><a href="index.html">ğŸ  é¦–é¡µ</a></li>
            <li><a href="register.html">ğŸ“ ç™»è®°</a></li>
            <li><a href="front-desk.html">ğŸ“º å‰å°çœ‹æ¿</a></li>
            <li><a href="repair.html">ğŸ”§ ç»´ä¿®çœ‹æ¿</a></li>
            <li><a href="customers.html">ğŸ‘¥ å®¢æˆ·</a></li>
            <li><a href="pricing.html">ğŸ’° ä»·æ ¼ç®¡ç†</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h2>ğŸ‘¤ ç”¨æˆ·ç®¡ç†</h2>
                <p>ç®¡ç†ç³»ç»Ÿç”¨æˆ·å’Œæƒé™</p>
            </div>
            <button class="btn btn-primary" onclick="showAddModal()">â• æ·»åŠ ç”¨æˆ·</button>
        </div>

        <div class="card">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ç”¨æˆ·å</th>
                            <th>å§“å</th>
                            <th>è§’è‰²</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="usersBody">
                        <tr>
                            <td colspan="5" class="empty-state">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- è§’è‰²è¯´æ˜ -->
        <div class="card" style="margin-top: 1.5rem;">
            <div class="card-header">
                <h3 class="card-title">ğŸ“‹ è§’è‰²æƒé™è¯´æ˜</h3>
            </div>
            <div style="padding: 1rem;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>è§’è‰²</th>
                            <th>è¯´æ˜</th>
                            <th>æƒé™</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="tag" style="background: var(--accent-orange);">admin</span></td>
                            <td>ç®¡ç†å‘˜</td>
                            <td>å…¨éƒ¨åŠŸèƒ½ + ç”¨æˆ·ç®¡ç†</td>
                        </tr>
                        <tr>
                            <td><span class="tag" style="background: var(--accent-purple);">boss</span></td>
                            <td>è€æ¿</td>
                            <td>å…¨éƒ¨åŠŸèƒ½ (æ— ç”¨æˆ·ç®¡ç†)</td>
                        </tr>
                        <tr>
                            <td><span class="tag" style="background: var(--accent-blue);">repair</span></td>
                            <td>ç»´ä¿®</td>
                            <td>ç»´ä¿®çœ‹æ¿ + å·¥å•ç¼–è¾‘</td>
                        </tr>
                        <tr>
                            <td><span class="tag" style="background: var(--accent-green);">frontdesk</span></td>
                            <td>å‰å°</td>
                            <td>ç™»è®° + å‰å°çœ‹æ¿</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="userModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="modalTitle">æ·»åŠ ç”¨æˆ·</h3>
                <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·å *</label>
                    <input type="text" class="form-control" id="userName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">å¯†ç  <span id="passwordHint"
                            style="color: var(--text-muted); font-size: 0.85rem;"></span></label>
                    <input type="password" class="form-control" id="userPassword" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹">
                </div>
                <div class="form-group">
                    <label class="form-label">å§“å</label>
                    <input type="text" class="form-control" id="userDisplayName">
                </div>
                <div class="form-group">
                    <label class="form-label">è§’è‰²</label>
                    <select class="form-control" id="userRole">
                        <option value="frontdesk">å‰å°</option>
                        <option value="repair">ç»´ä¿®</option>
                        <option value="boss">è€æ¿</option>
                        <option value="admin">ç®¡ç†å‘˜</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-ghost" onclick="closeModal('userModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script>
        // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        if (currentUser.role !== 'admin') {
            alert('æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡µé¢');
            window.location.href = 'index.html';
        }

        let editingId = null;

        // è§’è‰²æ˜¾ç¤ºæ˜ å°„
        const roleMap = {
            admin: { label: 'ç®¡ç†å‘˜', color: 'var(--accent-orange)' },
            boss: { label: 'è€æ¿', color: 'var(--accent-purple)' },
            repair: { label: 'ç»´ä¿®', color: 'var(--accent-blue)' },
            frontdesk: { label: 'å‰å°', color: 'var(--accent-green)' }
        };

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            try {
                const response = await fetch('/api/auth/users');
                const users = await response.json();
                const tbody = document.getElementById('usersBody');

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">æš‚æ— ç”¨æˆ·</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(user => {
                    const role = roleMap[user.role] || { label: user.role, color: 'var(--text-muted)' };
                    return `
                        <tr>
                            <td><strong>${user.username}</strong></td>
                            <td>${user.name || '-'}</td>
                            <td><span class="tag" style="background: ${role.color};">${role.label}</span></td>
                            <td>${utils.formatDate(user.created_at)}</td>
                            <td class="actions">
                                <button class="btn btn-sm btn-ghost" onclick="editUser(${user.id}, '${user.username}', '${user.name || ''}', '${user.role}')">âœï¸ ç¼–è¾‘</button>
                                ${user.username !== 'admin' ? `<button class="btn btn-sm btn-ghost" style="color: var(--accent-orange);" onclick="deleteUser(${user.id}, '${user.username}')">ğŸ—‘ï¸ åˆ é™¤</button>` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæ·»åŠ æ¨¡æ€æ¡†
        function showAddModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'æ·»åŠ ç”¨æˆ·';
            document.getElementById('passwordHint').textContent = '(å¿…å¡«)';
            document.getElementById('userForm').reset();
            document.getElementById('userPassword').required = true;
            openModal('userModal');
        }

        // ç¼–è¾‘ç”¨æˆ·
        function editUser(id, username, name, role) {
            editingId = id;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ç”¨æˆ·';
            document.getElementById('passwordHint').textContent = '(ç•™ç©ºä¸ä¿®æ”¹)';
            document.getElementById('userId').value = id;
            document.getElementById('userName').value = username;
            document.getElementById('userDisplayName').value = name;
            document.getElementById('userRole').value = role;
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').required = false;
            openModal('userModal');
        }

        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(id, username) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${username}" å—ï¼Ÿ`)) return;

            try {
                const response = await fetch(`/api/auth/users/${id}`, { method: 'DELETE' });
                const result = await response.json();

                if (response.ok) {
                    utils.showToast('ç”¨æˆ·å·²åˆ é™¤');
                    loadUsers();
                } else {
                    utils.showToast(result.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                utils.showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // è¡¨å•æäº¤
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                username: document.getElementById('userName').value.trim(),
                name: document.getElementById('userDisplayName').value.trim(),
                role: document.getElementById('userRole').value
            };

            const password = document.getElementById('userPassword').value;
            if (password) data.password = password;

            try {
                let response;
                if (editingId) {
                    response = await fetch(`/api/auth/users/${editingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    data.password = password;
                    response = await fetch('/api/auth/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                const result = await response.json();

                if (response.ok) {
                    utils.showToast(editingId ? 'ç”¨æˆ·å·²æ›´æ–°' : 'ç”¨æˆ·å·²åˆ›å»º');
                    closeModal('userModal');
                    loadUsers();
                } else {
                    utils.showToast(result.error || 'ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                utils.showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        });

        // åˆå§‹åŒ–
        loadUsers();
    </script>
</body>

</html>